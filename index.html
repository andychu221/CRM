
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Request Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill Libraries -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Chart.js for Market Tab -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- File Parsing Libraries for Real Preview -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Modern Warm Style */
            --bg-gradient: linear-gradient(180deg, #fdfbf7 0%, #fffef0 100%);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            
            /* Tabs */
            --tab-active-bg: #ffffff;
            --tab-inactive-bg: #f8fafc;
            --tab-inactive-text: #64748b;
            
            --primary-color: #eab308; /* Yellow-500 */
            --accent-blue: #3b82f6;
            
            --status-green: #10b981;
            --status-gray: #e5e7eb;
            --status-blue: #3b82f6;
            --status-red: #ef4444;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

            /* Market Colors */
            --positive-color: #28a745;
            --negative-color: #dc3545;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
            overflow-y: hidden; 
        }

        /* --- Layout --- */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- Header --- */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-top: 10px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            margin-right: 40px;
        }
        .brand-icon {
            background: #fef08a;
            color: #854d0e;
            padding: 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Tabs --- */
        .nav-tabs {
            display: flex;
            gap: 6px;
        }

        .nav-tab {
            padding: 8px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: var(--tab-inactive-text);
            background: var(--tab-inactive-bg); 
            border: 1px solid transparent; 
            position: relative;
            top: 1px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .nav-tab:hover {
            background: #cbd5e1;
            color: #1e293b;
        }

        .nav-tab.active {
            background: white;
            color: #111;
            border: 1px solid #d1d5db;
            border-bottom: 1px solid white;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.02);
            z-index: 10;
        }
        
        .nav-tab.active::before {
            content: '';
            position: absolute;
            top: -3px; left: 0; right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        /* --- Main Content --- */
        #main-content {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0 12px 12px 12px;
            box-shadow: var(--shadow-sm);
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .view-section {
            padding: 24px;
            height: 100%;
            overflow-y: auto;
            display: none;
        }
        
        .view-section.active { 
            display: block; 
            animation: slideUpFade 0.4s ease-out;
        }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- User Profile & Settings --- */
        .user-area-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
        }

        .settings-btn {
            color: #6b7280;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .settings-btn:hover { background: #f3f4f6; color: #111; }

        .user-container { position: relative; }
        .avatar {
            width: 36px; height: 36px;
            background: #374151; color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; cursor: pointer;
            box-shadow: var(--shadow-md);
            border: 2px solid white;
        }
        .role-badge {
            position: absolute; bottom: -4px; right: -4px;
            background: var(--primary-color); color: white;
            font-size: 10px; padding: 2px 5px;
            border-radius: 10px; border: 1px solid white;
        }
        .dropdown-menu {
            position: absolute; top: 110%; right: 0;
            background: white; border-radius: 8px;
            box-shadow: var(--shadow-md); width: 180px;
            border: 1px solid #e5e7eb; display: none; z-index: 50;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 10px; font-size: 0.9rem; cursor: pointer;
            display: flex; justify-content: space-between;
        }
        .dropdown-item:hover { background: #f9fafb; }
        .dropdown-item.active { background: #fefce8; color: #854d0e; }

        /* --- Notebook Cards --- */
        .notebook-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .notebook-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            position: relative;
        }
        .notebook-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: #d1d5db;
        }
        .notebook-card.active-turn {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.2);
        }

        .notebook-card.returned {
            background: #fff5f5; 
            border-color: #fecaca;
        }
        .notebook-card.returned:hover {
            background: #fff1f2;
            border-color: #fca5a5;
        }

        .notebook-card.new-request {
            border: 2px dashed #e5e7eb;
            align-items: center; justify-content: center;
            color: #9ca3af;
            min-height: 200px;
            background: white;
        }
        .notebook-card.new-request:hover {
            border-color: var(--accent-blue); color: var(--accent-blue);
            background: #eff6ff;
        }

        .card-delete-btn {
            position: absolute;
            top: 10px; right: 10px;
            color: #d1d5db;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
            z-index: 5;
        }
        .card-delete-btn:hover { color: #ef4444; background: #fef2f2; }

        .card-progress-area {
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
            position: relative;
        }
        .notebook-card.returned .card-progress-area { border-top-color: #fee2e2; }

        .next-approver-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
            text-align: right;
            font-weight: 600;
            height: 16px;
        }

        .progress-bars { display: flex; gap: 4px; height: 6px; margin-bottom: 2px; }
        .p-bar { flex: 1; background: #e5e7eb; border-radius: 4px; }
        .p-bar.done { background: var(--status-green); }
        .p-bar.active { background: var(--status-blue); }
        .p-bar.rejected { background: var(--status-red); }

        /* --- Request Detail Layout --- */
        .detail-layout { display: flex; height: 100%; background: #fff; position: relative; overflow: hidden; }
        
        .detail-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .detail-toolbar {
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        .detail-content {
            padding: 30px;
            overflow-y: auto;
            background: #fafafa;
        }

        /* Sidebar & Resizer */
        .sidebar-resizer {
            width: 12px;
            background: #f3f4f6;
            cursor: col-resize;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            transition: background 0.2s;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }
        .sidebar-resizer:hover, .sidebar-resizer.resizing { background: #dbeafe; }
        
        .sidebar-toggle-divider {
            width: 20px;
            height: 40px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #6b7280;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 30;
        }
        .sidebar-toggle-divider:hover { color: #111; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .detail-sidebar {
            width: 380px;
            background: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.1s;
            position: relative;
        }
        .detail-sidebar.collapsed { width: 0 !important; border:none; }
        .detail-sidebar.collapsed .sidebar-header,
        .detail-sidebar.collapsed .workflow-wrapper,
        .detail-sidebar.collapsed .action-area { display: none; }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 700;
            color: #374151;
            display: flex; justify-content: space-between; align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        .workflow-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .workflow-content { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1;
        }
        
        .sidebar-vertical-resizer {
            height: 8px;
            background: #f3f4f6;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            cursor: row-resize;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            z-index: 10;
        }
        .sidebar-vertical-resizer:hover { background: #e5e7eb; }
        .sidebar-vertical-resizer::after {
            content: '';
            width: 40px; height: 3px; background: #cbd5e1; border-radius: 2px;
        }

        /* Workflow Item */
        .wf-item { margin-bottom: 20px; display: flex; gap: 12px; position: relative; transition: all 0.3s;}
        .wf-item.dragging { opacity: 0.5; background: #f0f9ff; }
        .wf-icon { margin-top: 4px; }
        .wf-details { flex: 1; }
        .wf-role { font-weight: 700; font-size: 0.95rem; color: #111; display: flex; align-items: center; justify-content: space-between; }
        .wf-meta { font-size: 0.85rem; color: #555; }
        .wf-time { font-size: 0.75rem; color: #888; }
        .wf-comment {
            margin-top: 4px; padding: 8px; background: #fefce8;
            border: 1px solid #fef08a; border-radius: 6px;
            font-size: 0.85rem; font-style: italic; color: #854d0e;
        }
        .delegation-btn {
            font-size: 0.75rem; color: var(--accent-blue); cursor: pointer; text-decoration: underline; margin-left: 8px;
        }
        .delegation-btn:hover { color: #1d4ed8; }
        .wf-control-btn {
            color: #9ca3af; cursor: pointer; font-size: 16px; margin-left: 5px;
        }
        .wf-control-btn:hover { color: #111; }
        .wf-delete-btn:hover { color: #ef4444; }

        /* Action Area */
        .action-area {
            background: #f9fafb;
            padding: 16px;
            flex-shrink: 0;
        }

        /* --- Paper Form Style --- */
        .paper-form {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
            color: #1f2937;
            font-family: 'Inter', sans-serif;
            box-shadow: var(--shadow-md);
        }
        .paper-form-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-transform: capitalize;
            color: #111;
        }
        .paper-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
            align-items: center;
        }
        .paper-header-row input {
            border: 1px solid transparent;
            background: transparent;
            font-weight: normal;
            font-family: inherit;
            font-size: inherit;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s;
            width: auto;
            min-width: 150px;
        }
        .paper-header-row input:focus {
             background: #eff6ff; border-color: #bfdbfe; outline: none;
        }
        .paper-header-row input[readonly] {
            cursor: default;
        }
        
        .paper-section {
            border: 1px solid #d1d5db;
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden;
        }
        .paper-section-header {
            background: #f3f4f6;
            padding: 8px 12px;
            font-weight: 600;
            border-bottom: 1px solid #d1d5db;
            font-size: 0.9rem;
            color: #374151;
            text-transform: capitalize;
        }
        
        .paper-grid-2 { display: grid; grid-template-columns: 1fr 1fr; }
        .paper-col { padding: 0; }
        .paper-col:first-child { border-right: 1px solid #d1d5db; }
        
        .paper-field-row { display: flex; border-bottom: 1px solid #e5e7eb; }
        .paper-field-row:last-child { border-bottom: none; }
        
        .paper-label {
            width: 160px; padding: 8px 12px; font-weight: 600; font-size: 0.85rem;
            background: #f9fafb; border-right: 1px solid #e5e7eb; flex-shrink: 0; color: #4b5563;
        }
        .paper-value {
            padding: 8px 12px; flex: 1; font-size: 0.9rem; display: flex; align-items: center; position: relative;
        }
        .paper-value input, .paper-value select {
            width: 100%; border: 1px solid transparent; outline: none; background: transparent; 
            font-family: inherit; font-size: inherit; padding: 2px;
            border-radius: 4px; transition: all 0.2s;
        }
        .paper-value input:focus, .paper-value select:focus { background: #eff6ff; border-color: #bfdbfe; }
        .paper-value.highlight { background: #fffbeb; }
        
        /* Quill Wrapper and Expand Button (Smaller Icon) */
        .editor-wrapper { position: relative; }
        .editor-expand-btn {
            position: absolute;
            top: 6px; right: 6px;
            width: 20px; height: 20px; /* Smaller button */
            display: none; 
            align-items: center; justify-content: center;
            background: transparent; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
            color: #9ca3af;
            transition: all 0.2s;
        }
        .editor-expand-btn .material-icons { font-size: 16px; } /* Smaller Icon */
        .editor-expand-btn:hover { background: rgba(0,0,0,0.05); color: #111; }
        .resizable-editor .editor-expand-btn { top: 4px; right: 4px; }

        .paper-editor { min-height: 100px; padding: 10px; font-family: inherit; }
        
        .editor-wrapper.readonly .ql-toolbar { display: none; }
        .editor-wrapper.readonly .ql-container { border: none !important; }
        .editor-wrapper.readonly .paper-editor { padding: 0; }

        .ql-container { font-family: 'Inter', sans-serif !important; font-size: 0.9rem !important; }
        .ql-toolbar { border-color: #d1d5db !important; background: #f9fafb; }
        .ql-container { border-color: #d1d5db !important; }
        
        .mcap-container { display: flex; width: 100%; gap: 4px; }
        .mcap-cell {
            flex: 1; background: #f3f4f6; padding: 6px; border-radius: 4px; text-align: center; position: relative;
        }
        .mcap-label { font-size: 10px; color: #666; display: block; margin-bottom: 2px;}
        .mcap-val { font-weight: 600; font-size: 12px;}

        /* Internal Tabs */
        .internal-tabs { display: flex; gap: 4px; align-items: flex-end;}
        .internal-tab {
            padding: 8px 20px; border-radius: 8px 8px 0 0; cursor: pointer;
            color: #6b7280; font-weight: 500; border: 1px solid transparent;
            margin-bottom: -1px; background: #f3f4f6;
        }
        .internal-tab.active {
            background: white; color: #111; border: 1px solid #e5e7eb;
            border-bottom: 1px solid white; font-weight: 600;
        }
        .internal-pane { display: none; }
        .internal-pane.active { display: block; animation: fadeIn 0.3s; }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
            background: #f8fafc;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent-blue); background: #eff6ff; color: var(--accent-blue); }

        /* Tables */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th {
            background: #f9fafb; padding: 12px; text-align: left;
            font-size: 0.85rem; color: #6b7280; font-weight: 600; border-bottom: 1px solid #e5e7eb; white-space: nowrap;
            cursor: pointer; user-select: none;
        }
        .data-table th:hover { background: #f3f4f6; color: #374151; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; }
        .data-table tr:hover td { background: #f9fafb; }

        /* Comment Editor */
        .resizable-editor {
            border: 1px solid #d1d5db;
            background: white;
            display: flex; flex-direction: column;
            margin-bottom: 12px;
            border-radius: 6px;
            overflow: auto; /* Changed from hidden to auto for resize handle visibility */
            min-height: 80px; 
            height: 120px;
            position: relative;
            resize: vertical; /* Allow resizing */
        }
        
        .resizable-editor .ql-toolbar { border:none !important; border-bottom: 1px solid #d1d5db !important; }
        .resizable-editor .ql-container { border:none !important; flex: 1; overflow-y: auto; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 200; display: none;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 8px; width: 320px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* Expanded Editor Modal */
        .expanded-editor-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 500; display: none;
            flex-direction: column;
        }
        .expanded-toolbar {
            padding: 10px 20px; background: #f3f4f6; border-bottom: 1px solid #d1d5db;
            display: flex; justify-content: flex-end; align-items: center;
        }
        .expanded-editor-container {
            flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%;
        }
        .expanded-editor-container .ql-container { border: 1px solid #d1d5db !important; border-top: none !important; flex: 1; overflow-y: auto;}

        /* Excel Tabs */
        .sheet-tabs { display: flex; gap: 4px; background: #f3f4f6; padding: 8px 12px 0 12px; border-bottom: 1px solid #d1d5db; overflow-x: auto; width: 100%;}
        .sheet-tab { 
            padding: 8px 16px; background: #e5e7eb; border-radius: 6px 6px 0 0; 
            cursor: pointer; font-size: 0.85rem; color: #555; 
            border: 1px solid #d1d5db; border-bottom: none;
            white-space: nowrap;
        }
        .sheet-tab:hover { background: #f9fafb; }
        .sheet-tab.active { background: white; color: #166534; font-weight: bold; border-bottom: 2px solid white; position: relative; top: 1px;}

        /* Excel Sheet Style */
        .excel-table { border-collapse: collapse; font-family: monospace; font-size: 13px; margin: 0; }
        .excel-table td, .excel-table th { border: 1px solid #d1d5db; padding: 4px 8px; min-width: 60px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .excel-header { background: #f3f4f6; color: #4b5563; font-weight: bold; text-align: center; user-select: none; }
        .excel-row-num { background: #f3f4f6; color: #4b5563; font-weight: bold; text-align: center; width: 40px; min-width: 40px; user-select: none; }
        
        /* Market Tab Styles (Legacy styles adapted for internal) */
        .summary-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: white; margin-bottom: 20px; overflow-x: auto; }
        /* Fix 1: Make table fit content with fixed layout and smaller text */
        #req-mkt-summary-container table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        #req-mkt-summary-container th, #req-mkt-summary-container td { 
            padding: 6px 4px; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 0.75rem; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #req-mkt-summary-container th:first-child, #req-mkt-summary-container td:first-child { text-align: left; }
        #req-mkt-summary-container th { background: #f9fafb; font-weight: 600; color: #6b7280; user-select: none; cursor: default; }
        #req-mkt-summary-container tr:hover td { background: #f9fafb; }
        
        .text-positive { color: var(--positive-color); font-weight: 500; }
        .text-negative { color: var(--negative-color); font-weight: 500; }
        
        .mkt-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; background: #f3f4f6; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb;}
        .mkt-input { padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; }
        .chart-period-btn { padding: 5px 12px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 0.9rem; color: #374151; }
        .chart-period-btn:hover { background: #f3f4f6; color: var(--primary-color); }
        .chart-period-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* Financials Tab Styles */
        /* Active Mode - Yellow Background White Text */
        .active-mode-yellow { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* Financials Resizer */
        .fin-th-wrapper { position: relative; display: flex; align-items: center; justify-content: space-between; height: 100%; }
        .resizer {
            position: absolute; top: 0; right: 0; width: 6px; cursor: col-resize; height: 100%; z-index: 10;
            background: transparent; border-right: 2px solid transparent;
        }
        .resizer:hover { border-right-color: #3b82f6; }

        /* Depth classes logic - approx 4 chars per step */
        .depth-0 { font-weight: 700; color: #1e3a8a; background-color: #f3f4f6; } /* Blue Bold, Light Gray BG */
        .depth-1 { font-weight: 700; color: #111; padding-left: 32px !important; }
		.depth-2 { color: #111; padding-left: 64px !important; }
		.depth-3 { color: #6b7280; padding-left: 96px !important; }
		.depth-4 { color: #6b7280; padding-left: 128px !important; }
        
        /* Financial Label Column (Fixed/Resizable via JS, min/max managed inline) */
        .fin-label-col {
			min-width: 280px;
    		white-space: nowrap;
    		overflow: hidden;
    		text-overflow: ellipsis;
    		position: relative;
		}

        /* Multi Select Dropdown Style for Financials */
        .multi-select-dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-btn {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex; align-items: center; justify-content: space-between;
            min-width: 120px;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #d1d5db;
            z-index: 100;
            border-radius: 4px;
            max-height: 400px;
            margin-top: 2px;
            
            /* Flex layout for sticky footer */
            display: none; /* toggled via class */
            flex-direction: column;
        }
        .dropdown-content.show { display: flex; }
        
        #fin-period-list {
            overflow-y: auto;
            flex: 1;
            max-height: 300px; /* Limit list height so footer is visible */
        }

        .dropdown-item-check {
            padding: 8px 12px;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            font-size: 0.9rem;
            color: #374151;
        }
        .dropdown-item-check:hover { background-color: #f3f4f6; }
        .dropdown-item.active { background: #eff6ff;
            color: var(--accent-blue);
            font-weight: 500;
        }

        .dropdown-footer {
            flex-shrink: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px;
            display: flex;
            justify-content: flex-end;
        }
        
        /* Market Split Pane Styles */
        .req-mkt-split { display: flex; height: 600px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .req-mkt-left { flex: 0 0 50%; padding: 10px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; min-width: 200px; transition: flex 0.3s ease; }
        .req-mkt-resizer { width: 5px; background: #f3f4f6; cursor: col-resize; transition: background 0.2s; z-index: 10; display: block; }
        .req-mkt-resizer:hover { background: var(--primary-color); }
        .req-mkt-right { flex: 1; padding: 10px; overflow-y: auto; background: #f9fafb; display: flex; flex-direction: column; min-width: 0; }
        
        .news-item { padding: 12px 15px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s; background: white; margin-bottom: 5px; border-radius: 4px; }
        .news-item:hover { background: #f3f4f6; }
        .news-meta { display: flex; gap: 8px; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px; align-items: center; }
        .news-tag { background: #e5e7eb; padding: 2px 6px; border-radius: 4px; }
        .news-title { font-weight: 600; font-size: 0.9rem; line-height: 1.4; color: #374151; }
        
        /* Utils */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        .btn-ghost { background: transparent; color: #374151; border-color: #d1d5db; }
        .btn-ghost:hover { background: #f3f4f6; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--status-green); color: white; }
        .btn-danger { background: var(--status-red); color: white; }
        .btn-danger-outline { background: white; color: var(--status-red); border: 1px solid var(--status-red); }
        .btn-danger-outline:hover { background: #fef2f2; }
        .btn-xs { padding: 2px 6px; font-size: 0.75rem; }
        
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .st-pending { background: #eff6ff; color: #1d4ed8; }
        .st-approved { background: #f0fdf4; color: #15803d; }
        .st-rejected { background: #fef2f2; color: #b91c1c; }
        .st-draft { background: #f3f4f6; color: #4b5563; }
        .st-cancelled { background: #e5e7eb; color: #6b7280; text-decoration: line-through; }
        .st-recalled { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        
        .btn-back { color: var(--accent-blue); font-weight: 600; }
        .btn-back:hover { background: #eff6ff; }
        
        /* Draggable Styles */
        .draggable-item { cursor: move; }
        .draggable-item.dragging { opacity: 0.5; background: #e0f2fe; }

        /* Print Styles */
        @media print {
            @page { size: auto; margin: 10mm; }
            body, .app-container { height: auto !important; display: block !important; padding: 0 !important; margin: 0 !important; overflow: visible !important; }
            .top-nav, .sidebar-resizer, .detail-sidebar, .detail-toolbar, .internal-tabs, #btn-save-draft, .drop-zone, .card-delete-btn, .file-delete-btn, .editor-expand-btn { display: none !important; }
            #main-content { border: none; box-shadow: none; border-radius: 0; }
            .detail-layout { display: block; overflow: visible; height: auto; }
            .detail-main { overflow: visible; height: auto; }
            .detail-content { padding: 0; overflow: visible; background: white; }
            .internal-pane { display: none !important; }
            .internal-pane.active { display: block !important; }
            body { background: white; font-size: 9pt; zoom: 0.8; }
            .paper-form { box-shadow: none; border: none; padding: 0; margin: 0; max-width: 100%; width: 100%; }
            .paper-form-title { text-align: center !important; margin-bottom: 20px; font-size: 1.5rem; width: 100%; display: block;}
            .paper-section { page-break-inside: avoid; margin-bottom: 15px; border-radius: 0; }
            .paper-section-header { padding: 4px 8px; font-size: 0.85rem; }
            .paper-field-row { border-bottom-color: #eee; }
            .paper-label { width: 120px; padding: 4px 8px; font-size: 0.8rem; }
            .paper-value { padding: 4px 8px; font-size: 0.8rem; }
            .paper-editor { min-height: auto; padding: 5px; }
            input, select { border: none !important; appearance: none; padding: 0; background: transparent !important; }
            
        }

    </style>
</head>
<body>

<div class="app-container">
    <header class="top-nav">
        <div class="brand">
            <div class="brand-icon"><span class="material-icons">assignment</span></div>
            <span>Credit Request Management</span>
        </div>
        
        <div class="nav-tabs" id="main-nav">
            <!-- Populated via JS -->
        </div>

        <div class="user-area-wrapper">
            <!-- Settings Icon -->
            <div class="settings-btn" onclick="openSettingsModal()" title="Workflow Settings">
                <span class="material-icons">settings</span>
            </div>

            <div class="user-container">
                <div class="avatar" id="current-user-avatar" onclick="toggleUserMenu(event)">M</div>
                <div class="role-badge" id="current-user-role">Maker</div>
                <div class="dropdown-menu" id="user-menu">
                    <!-- Populated via JS -->
                </div>
            </div>
        </div>
    </header>

    <main id="main-content">
        
        <div id="view-dashboard" class="view-section active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800" id="dashboard-greeting">Active Requests</h2>
            </div>
            <div class="notebook-grid" id="notebook-container">
                <!-- Populated via JS -->
            </div>
        </div>

        <div id="view-request-detail" class="view-section" style="padding: 0; display: none;">
            <div class="detail-layout">
                <div class="detail-main">
                    <div class="detail-toolbar">
                        <button class="btn btn-ghost btn-back" onclick="handleBackNav()">
                            <span class="material-icons">arrow_back</span> Back
                        </button>
                        <div class="font-bold text-lg" id="detail-header-title">Request #001</div>
                        
                        <div class="flex gap-2 items-center">
                             <button class="btn btn-ghost" id="btn-save-draft" onclick="saveDraft()" style="display:none;"><span class="material-icons">save</span> Save</button>
                            <button class="btn btn-ghost" onclick="window.print()"><span class="material-icons">print</span> Print</button>
                        </div>
                    </div>

                    <div class="detail-content" id="form-container">
                        <div class="internal-tabs">
                            <div class="internal-tab active" onclick="switchInternalTab('req-form', this)" id="tab-req-form">Request Form</div>
                            <div class="internal-tab" onclick="switchInternalTab('review-form', this)" id="tab-review-form">Review Form</div>
                            <div class="internal-tab" onclick="switchInternalTab('summary', this)" id="tab-summary">One-Pager</div>
                            <div class="internal-tab" onclick="switchInternalTab('financials', this)">Financials</div>
                            <div class="internal-tab" onclick="switchInternalTab('market', this)" id="tab-market">
                                Market
                                <span class="material-icons text-gray-400 hover:text-gray-800 text-xs ml-1" id="btn-toggle-mkt-tab" onclick="toggleMarketTabVisibility(event)" title="Hide Market Tab">visibility</span>
                            </div>
                        </div>

                        <div id="pane-req-form" class="internal-pane active">
                            <div class="paper-form">
                                <div class="paper-form-title">Customer Credit Application</div>
                                
                                <div class="paper-section">
                                    <div class="paper-section-header">General Information</div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Ticker</div>
                                        <div class="paper-value"><input type="text" id="frm-ticker" placeholder="Type AAPL, NVDA..." oninput="handleTickerInput(this)"></div>
                                    </div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Company Name</div>
                                        <div class="paper-value"><input type="text" id="frm-name"></div>
                                    </div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Request Date</div>
                                        <div class="paper-value"><input type="date" id="frm-date"></div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Request Purpose</div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Type</div>
                                        <div class="paper-value">
                                            <div class="multi-select-dropdown w-full" id="purpose-selector" onclick="event.stopPropagation()">
                                                <button class="dropdown-btn w-full" id="btn-purpose-dropdown" onclick="togglePurposeDropdown()">
                                                    <span id="purpose-display" class="truncate">Select Purpose</span>
                                                    <span class="material-icons text-sm">arrow_drop_down</span>
                                                </button>
                                                <div class="dropdown-content w-full flex-col" id="purpose-dropdown-content">
                                                     <div class="dropdown-item-check" onclick="togglePurpose('New Credit Line', this)">
                                                        <span class="material-icons text-sm">check_box_outline_blank</span> New Credit Line
                                                     </div>
                                                     <div class="dropdown-item-check" onclick="togglePurpose('Credit Line Change', this)">
                                                        <span class="material-icons text-sm">check_box_outline_blank</span> Credit Line Change
                                                     </div>
                                                     <div class="dropdown-item-check" onclick="togglePurpose('Payment Term Change', this)">
                                                        <span class="material-icons text-sm">check_box_outline_blank</span> Payment Term Change
                                                     </div>
                                                     <div class="dropdown-item-check" onclick="togglePurpose('Add New Entity to Share', this)">
                                                        <span class="material-icons text-sm">check_box_outline_blank</span> Add New Entity to Share
                                                     </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="frm-purpose">
                                        </div>
                                    </div>
									<div class="paper-field-row">
                                        <div class="paper-label">Reason</div>
										<div class="paper-value"><input type="text" id="frm-type-reason" placeholder="Reason for selection"></div>
                                    </div>
                                    <div class="paper-field-row hidden" id="shared-entity-row">
                                        <div class="paper-label">Shared Entities</div>
                                        <div class="paper-value"><input type="text" id="frm-shared-tickers" placeholder="e.g. AAPL, GOOGL"></div>
                                    </div>
                                    <div class="paper-field-row hidden" id="shared-purpose-row">
                                        <div class="paper-label">Description</div>
                                        <div class="paper-value"><input type="text" id="frm-shared-purpose" placeholder="Sharing arrangement description"></div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Limits & Terms</div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Current Line</div>
                                        <div class="paper-value"><input type="text" id="frm-curr-limit"></div>
                                    </div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Proposed Line</div>
                                        <div class="paper-value highlight">
                                            <input type="text" id="frm-prop-limit" 
                                                   oninput="handleLimitChange()" 
                                                   onchange="handleLimitChange()"
                                                   onkeyup="handleLimitChange()">
                                        </div>
                                    </div>
                                    <div class="paper-field-row">
                                        <div class="paper-label">Payment Term</div>
                                        <div class="paper-value">
                                            <select id="frm-payterm-select" onchange="handlePayTermChange()">
                                                <option value="Net 30">Net 30</option>
                                                <option value="Net 60">Net 60</option>
                                                <option value="Net 90">Net 90</option>
                                                <option value="Others">Others</option>
                                            </select>
                                            <input type="text" id="frm-payterm-other" class="hidden ml-2 border-b border-gray-300" placeholder="Specify term">
                                        </div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Order Forecast</div>
                                    <div id="wrapper-forecast" class="editor-wrapper">
                                        <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-forecast')"><span class="material-icons">open_in_full</span></div>
                                        <div id="editor-forecast" class="paper-editor"></div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Business Description</div>
                                    <div id="wrapper-biz-desc" class="editor-wrapper">
                                        <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-biz-desc')"><span class="material-icons">open_in_full</span></div>
                                        <div id="editor-biz-desc" class="paper-editor"></div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Attachments</div>
                                    <div class="p-4">
                                        <div id="drop-zone" class="drop-zone hidden" 
                                             onclick="document.getElementById('file-upload-input').click()"
                                             ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                                            <span class="material-icons text-3xl mb-2">cloud_upload</span>
                                            <div>Click or Drag & Drop files here</div>
                                            <div class="text-xs text-gray-400 mt-1">Supports Multiple Files (PDF, Excel, Word)</div>
                                            <input type="file" id="file-upload-input" multiple class="hidden" onchange="handleFileSelect(event, 'request')">
                                        </div>
                                        <div class="flex gap-4 flex-wrap" id="file-list-area"></div>
                                    </div>
                                </div>

                                <div class="mt-8 pt-4 border-t border-gray-300 text-sm flex items-end">
                                    <div class="font-bold mr-2">Prepared by:</div>
                                    <input type="text" id="req-prepared-by" class="border-b border-gray-400 outline-none w-64 bg-transparent" value="Tim Cook">
                                </div>
                            </div>
                        </div>

                        <div id="pane-review-form" class="internal-pane">
                            <div class="paper-form">
                                <div class="paper-form-title">Customer Credit Review</div>
                                
                                <div class="paper-header-row">
                                    <div class="flex items-center">
                                        <strong>Customer:</strong> 
                                        <input type="text" id="rev-header-name" readonly class="ml-2 font-bold text-lg">
                                    </div>
                                    <div class="flex items-center">
                                        <strong>Date:</strong> 
                                        <!-- Point 3: Auto Calc Trigger -->
                                        <input type="date" id="rev-header-date" readonly class="ml-2" onchange="calculateReviewMarketCap()">
                                    </div>
                                </div>
                                <div class="paper-header-row">
                                    <div class="flex items-center w-full">
                                        <strong>Parent Company:</strong> 
                                        <input type="text" id="rev-header-parent" readonly class="ml-2 w-full">
                                    </div>
                                </div>
                                <div class="paper-header-row mb-4">
                                    <div class="flex items-center w-full">
                                        <strong>Line Shared Entities:</strong> 
                                        <input type="text" id="rev-header-shared" readonly class="ml-2 w-full">
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-grid-2">
                                        <div class="paper-col">
                                            <div class="paper-field-row">
                                                <div class="paper-label">Customer Code</div>
                                                <div class="paper-value"><input type="text" id="rev-code"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Region / AM</div>
                                                <div class="paper-value"><input type="text" id="rev-region-am"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Relation Since</div>
                                                <div class="paper-value"><input type="text" id="rev-since"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Last Review</div>
                                                <div class="paper-value"><input type="text" id="rev-last-rev"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Next Review</div>
                                                <div class="paper-value"><input type="text" id="rev-next-rev"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Int / Ext Rating</div>
                                                <div class="paper-value"><input type="text" id="rev-rating"></div>
                                            </div>
                                        </div>
                                        <div class="paper-col">
                                            <div class="paper-field-row">
                                                <div class="paper-label">Credit Line</div>
                                                <div class="paper-value"><input type="text" id="rev-credit-line"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Utilization (%)</div>
                                                <div class="paper-value"><input type="text" id="rev-util"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">AR Outstanding</div>
                                                <div class="paper-value"><input type="text" id="rev-ar"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Overdue / % AR</div>
                                                <div class="paper-value"><input type="text" value="0 / 0%"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">Payment Term</div>
                                                <div class="paper-value"><input type="text" id="rev-payterm"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label">WACD</div>
                                                <div class="paper-value"><input type="text" value="1.5%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Purpose Of This Request</div>
                                    <div class="paper-value">
                                        <div id="wrapper-purpose" class="editor-wrapper w-full">
                                            <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-purpose')"><span class="material-icons">open_in_full</span></div>
                                            <div id="editor-purpose" class="paper-editor" style="min-height: 80px;"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="paper-section">
                                    <div class="paper-section-header">Market Data</div>
                                    <div class="paper-grid-2" style="grid-template-columns: 0.9fr 1.1fr;">
                                        <div class="paper-col">
                                            <div class="paper-field-row">
                                                <div class="paper-label" style="width: 130px;">Business Domain</div>
                                                <div class="paper-value"><input type="text" id="rev-domain"></div>
                                            </div>
                                            <div class="paper-field-row">
                                                <div class="paper-label" style="width: 130px;">Listed/Private</div>
                                                <div class="paper-value"><input type="text" id="rev-listed-display"></div>
                                            </div>
                                        </div>
                                        <div class="paper-col">
                                            <div class="paper-field-row" style="height: 100%;">
                                                <div class="paper-label" style="height: auto; width: 100px;">Market Cap<br><span style="font-size:0.75rem; font-weight:normal;">(12M)</span></div>
                                                <div class="paper-value" style="padding: 4px 8px;">
                                                    <div class="mcap-container">
                                                        <div class="mcap-cell" style="flex: 1;">
                                                            <span class="mcap-label">Current</span>
                                                            <div id="mcap-curr" class="text-center text-xs leading-tight min-h-[30px] flex flex-col justify-center"></div>
                                                        </div>
                                                        <div class="mcap-cell" style="flex: 1;">
                                                            <span class="mcap-label">High</span>
                                                            <div id="mcap-high" class="text-center text-xs leading-tight min-h-[30px] flex flex-col justify-center"></div>
                                                        </div>
                                                        <div class="mcap-cell" style="flex: 1;">
                                                            <span class="mcap-label">Low</span>
                                                            <div id="mcap-low" class="text-center text-xs leading-tight min-h-[30px] flex flex-col justify-center"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-2 px-1">
                                    <input type="text" id="rev-risk-subtitle" 
                                           class="text-sm text-black bg-transparent border-none w-full max-w-md focus:outline-none font-normal" 
                                           placeholder="Financials as of FYXX ended MM/DD/2025">
                                </div>
								
                                <div class="paper-section" id="risk-analysis-block">
                                    <div class="paper-section-header">Key Risks Analysis</div>
									
                                    <div class="paper-grid-2">
                                        <div class="paper-col" style="border-right:1px solid #d1d5db;">
                                            <div class="p-2 font-bold underline text-xs text-gray-500">Major Credit Risks</div>
                                            <div id="wrapper-risks" class="editor-wrapper">
                                                <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-risks')"><span class="material-icons">open_in_full</span></div>
                                                <div id="editor-risks" class="paper-editor"></div>
                                            </div>
                                        </div>
                                        <div class="paper-col">
                                            <div class="p-2 font-bold underline text-xs text-gray-500">Mitigants</div>
                                            <div id="wrapper-mitigants" class="editor-wrapper">
                                                <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-mitigants')"><span class="material-icons">open_in_full</span></div>
                                                <div id="editor-mitigants" class="paper-editor"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="paper-section" style="margin-bottom:0;">
                                    <div class="paper-section-header">Decision / Comments</div>
                                    <div id="wrapper-recommendation" class="editor-wrapper">
                                        <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-recommendation')"><span class="material-icons">open_in_full</span></div>
                                        <div id="editor-recommendation" class="paper-editor"></div>
                                    </div>
                                </div>

                                <div class="paper-section mt-4 hidden" id="reviewer-upload-section">
                                    <div class="paper-section-header">Attachments</div>
                                    <div class="p-4">
                                        <div id="drop-zone-reviewer" class="drop-zone" 
                                             onclick="document.getElementById('rev-file-input').click()"
                                             ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'review')">
                                            <span class="material-icons text-3xl mb-2">cloud_upload</span>
                                            <div>Click or Drag & Drop files here</div>
                                            <input type="file" id="rev-file-input" multiple class="hidden" onchange="handleFileSelect(event, 'review')">
                                        </div>
                                        <div class="flex gap-4 flex-wrap mt-2" id="reviewer-file-list-area"></div>
                                    </div>
                                </div>

                                <div class="mt-8 pt-4 border-t border-gray-300 text-sm flex items-end">
                                    <div class="font-bold mr-2">Prepared by:</div>
                                    <input type="text" id="rev-prepared-by" class="border-b border-gray-400 outline-none w-64 bg-transparent" value="Jensen Huang">
                                </div>

                            </div>
                        </div>

                        <div id="pane-summary" class="internal-pane">
                             <div class="paper-form">
                                <div class="paper-form-title">Credit Summary</div>
                                <div id="wrapper-summary" class="editor-wrapper">
                                    <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-summary')"><span class="material-icons">open_in_full</span></div>
                                    <div id="editor-summary" class="paper-editor" style="min-height: 600px;"></div>
                                </div>
                            </div>
                        </div>

                        <div id="pane-financials" class="internal-pane">
                            <div class="paper-form" style="max-width: 1400px;">
                                <div class="paper-form-title">Financial Summary</div>
                                
                                <div id="fin-controls-toolbar" class="flex justify-between items-center mb-4 bg-gray-50 p-3 rounded border border-gray-200">
                                    <div class="flex gap-4 items-center">
                                        <!-- New Multi-select Dropdown -->
                                        <div class="multi-select-dropdown" id="fin-period-selector" onclick="event.stopPropagation()">
                                            <button class="dropdown-btn" onclick="fin_togglePeriodDropdown()">
                                                <span id="fin-period-label">Select Periods</span>
                                                <span class="material-icons text-sm">arrow_drop_down</span>
                                            </button>
                                            <div class="dropdown-content" id="fin-period-dropdown-content">
                                                <div id="fin-period-list"></div>
                                                <div class="dropdown-footer">
                                                    <button class="btn btn-primary btn-sm" onclick="fin_confirmPeriods()">Done</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4">
                                         <button class="btn btn-ghost btn-sm" onclick="fin_openRowConfig()"><span class="material-icons text-sm">view_headline</span> Row Config</button>
                                        <div class="flex bg-white border rounded overflow-hidden shadow-sm">
                                            <button class="px-3 py-1 hover:bg-gray-100 text-sm font-bold transition-colors" id="btn-fin-ann" onclick="fin_setPeriodMode('Annual')">Annual</button>
                                            <button class="px-3 py-1 hover:bg-gray-100 text-sm font-bold active-mode-yellow transition-colors" id="btn-fin-qtr" onclick="fin_setPeriodMode('Quarterly')">Quarterly</button>
                                        </div>
                                        <button class="btn btn-primary btn-sm ml-2" onclick="fin_saveConfig()"><span class="material-icons text-sm">save</span> Save Layout</button>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-end mb-2 pt-2 border-t border-gray-200">
                                     <span class="font-bold text-lg text-gray-800 pl-1" id="fin-company-display">Company Name</span>
                                     <span class="text-sm font-bold text-gray-500 ml-2">Unit: US$ M</span>
                                </div>

                                <!-- Table Container -->
                                <div id="fin-table-container" class="overflow-auto border border-gray-200 rounded bg-white shadow-sm flex-1 relative">
                                    <!-- Table generated here -->
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Internal Market Pane -->
                        <div id="pane-market" class="internal-pane">
                            <div class="paper-form" style="max-width: 1400px; padding: 20px;">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex items-center gap-2">
                                        <label class="font-bold text-sm text-gray-600">As of Date:</label>
                                        <input type="date" id="req-mkt-as-of-date" class="border rounded p-1 text-sm bg-gray-50" onchange="req_mkt_refreshAll()">
                                    </div>
                                    <div class="flex-1 text-center">
                                        <div class="paper-form-title mb-0" id="req-mkt-title">[Company Name]'s Share Price & News</div>
                                    </div>
                                    <div style="width: 200px;"></div> <!-- Spacer to balance layout -->
                                </div>
                                
                                <!-- Top: Summary Table Row -->
                                <div class="summary-card mb-4" id="req-mkt-summary-container">
                                    <table>
                                        <thead id="req-mkt-thead">
                                            <tr>
                                                <th>Name</th>
                                                <th>Ticker</th>
                                                <th>Date</th>
                                                <th>Market Cap</th>
                                                <th>Price</th>
                                                <th>1D %</th>
                                                <th>1W %</th>
                                                <th>1M %</th>
                                                <th>3M %</th>
                                                <th>6M %</th>
                                                <th>YTD %</th>
                                                <th>1Y %</th>
                                                <th>2Y %</th>
                                            </tr>
                                        </thead>
                                        <tbody id="req-mkt-tbody">
                                            <tr><td colspan="13" class="text-center p-4">Loading market data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Bottom: Split View (Chart & News) -->
                                <div class="req-mkt-split">
                                    <!-- Left: Chart -->
                                    <div class="req-mkt-left" id="req-mkt-left-pane">
                                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                                            <h3 class="font-bold text-gray-700">Price Chart</h3>
                                            <div class="flex gap-1" id="req-mkt-chart-controls">
                                                <button class="chart-period-btn btn-xs" data-period="1M" onclick="req_mkt_updateChart('1M')">1M</button>
                                                <button class="chart-period-btn btn-xs" data-period="3M" onclick="req_mkt_updateChart('3M')">3M</button>
                                                <button class="chart-period-btn btn-xs" data-period="6M" onclick="req_mkt_updateChart('6M')">6M</button>
                                                <button class="chart-period-btn btn-xs" data-period="YTD" onclick="req_mkt_updateChart('YTD')">YTD</button>
                                                <button class="chart-period-btn btn-xs active" data-period="1Y" onclick="req_mkt_updateChart('1Y')">1Y</button>
                                                <button class="chart-period-btn btn-xs" data-period="2Y" onclick="req_mkt_updateChart('2Y')">2Y</button>
                                            </div>
                                        </div>
                                        <div class="flex-1 relative">
                                            <canvas id="req-mkt-chart-canvas"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Resizer -->
                                    <div class="req-mkt-resizer" id="req-mkt-resizer" onclick="toggleNewsPane(true)"></div>
                                    
                                    <!-- Right: News List -->
                                    <div class="req-mkt-right" id="req-mkt-news-list">
                                        <div class="flex justify-between items-center mb-2 border-b pb-2" id="req-mkt-news-header">
                                            <h3 class="font-bold text-gray-700">Recent News</h3>
                                            <button class="text-xs text-gray-400 hover:text-red-500 flex items-center" onclick="toggleNewsPane(false)">
                                                <span class="material-icons text-sm">visibility_off</span> Hide
                                            </button>
                                        </div>
                                        <div id="req-mkt-news-content">
                                             <p class="p-4 text-gray-500">Loading news...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="sidebar-resizer" id="resizer">
                    <div class="sidebar-toggle-divider" onclick="toggleSidebar()" title="Toggle Sidebar">
                        <span class="material-icons" style="font-size:16px;">chevron_right</span>
                    </div>
                </div>

                <div class="detail-sidebar" id="workflow-sidebar">
                    <div class="sidebar-header">
                        <span class="font-bold">Approval Workflow</span>
                        <button id="btn-edit-workflow" class="btn btn-ghost btn-sm hidden" onclick="toggleWorkflowEditMode()" title="Edit Workflow">
                            <span class="material-icons text-blue-500">edit_road</span>
                        </button>
                    </div>

                    <div class="workflow-wrapper" id="workflow-wrapper">
                        <div class="workflow-content" id="workflow-list">
                            <!-- Populated via JS -->
                        </div>
                        
                        <div id="workflow-edit-controls" class="hidden p-3 bg-blue-50 border-t border-b border-blue-200">
                            <div class="text-xs font-bold text-blue-800 mb-2">Workflow Management</div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary btn-sm w-full" onclick="addWorkflowStep()">+ Step</button>
                                <button class="btn btn-ghost btn-sm w-full" onclick="toggleWorkflowEditMode()">Done</button>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">Drag or use arrow buttons to reorder</div>
                        </div>
                    </div>

                    <div class="sidebar-vertical-resizer" id="vertical-resizer"></div>

                    <div class="p-4 bg-gray-50 action-area" id="workflow-actions">
                        <div id="return-options" class="mb-3 hidden">
                             <label class="text-xs font-bold text-red-500 mb-1 block">Return To Step:</label>
                             <select class="f-select text-sm p-2 w-full border rounded" id="return-target-step"></select>
                        </div>
                        
                        <div id="comment-section-wrapper">
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-xs font-bold text-gray-500">Comments</label>
                            </div>
                            <div id="wrapper-action-comment" class="resizable-editor editor-wrapper">
                                <div class="editor-expand-btn" onclick="openExpandedEditor('wrapper-action-comment')"><span class="material-icons">open_in_full</span></div>
                                <div id="editor-action-comment"></div>
                            </div>
                        </div>
                        
                        <div id="maker-action-buttons" class="hidden flex gap-2 mb-2">
                             <button class="btn btn-success flex-1 text-white" onclick="processAction('approve')">Resubmit</button>
                             <button class="btn btn-danger flex-1 text-white" onclick="cancelRequest()">Cancel</button>
                        </div>
                        
                        <!-- Recall Button -->
                        <div id="recall-button-area" class="hidden mb-2">
                            <button class="btn btn-danger-outline w-full" onclick="recallRequest()">Recall Request</button>
                        </div>

                        <div id="standard-action-buttons" class="flex gap-2 mb-2">
                            <button class="btn btn-success flex-1" id="btn-approve" onclick="processAction('approve')">Approve</button>
                            <button class="btn btn-danger flex-1" id="btn-return" onclick="toggleReturnMode()">Return</button>
                        </div>

                        <div class="hidden flex gap-2" id="return-confirm-area">
                             <button class="btn btn-danger flex-1" onclick="processAction('reject')">Confirm Return</button>
                             <button class="btn btn-ghost flex-1" onclick="cancelReturnMode()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-customer-master" class="view-section">
            <!-- Customer Master Content -->
            <div class="flex justify-between mb-4">
                <h2 class="text-xl font-bold">Customer Master Database</h2>
            </div>
            <div class="bg-white rounded shadow-sm overflow-hidden border border-gray-200 overflow-x-auto">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortCustomerMaster('id')">Ticker <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('name')">Name <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('family')">Family <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('region')">Region <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('sector')">Sector <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('domain')">Domain <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('am')">Account Manager <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('creditLine')">Credit Line <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('ar')">A/R Bal <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('util')">Util % <span class="material-icons text-sm align-middle">unfold_more</span></th>
                            <th onclick="sortCustomerMaster('lastRev')">Last Review <span class="material-icons text-sm align-middle">unfold_more</span></th>
                        </tr>
                    </thead>
                    <tbody id="master-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-historical" class="view-section">
            <h2 class="text-xl font-bold mb-4">Application History</h2>
            <!-- History Content -->
            <div class="flex flex-wrap gap-4 mb-4 bg-white p-3 rounded shadow-sm border border-gray-200 items-end">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Ticker</label>
                    <input type="text" id="hist-filter-ticker" class="border rounded p-2 text-sm w-32" placeholder="Search..." oninput="renderHistorical()">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Purpose</label>
                    <select id="hist-filter-purpose" class="border rounded p-2 text-sm w-40" onchange="renderHistorical()">
                        <option value="">All</option>
                        <option value="New Credit Line">New Credit Line</option>
                        <option value="Credit Line Change">Credit Line Change</option>
                    </select>
                </div>
                 <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Status</label>
                    <select id="hist-filter-status" class="border rounded p-2 text-sm w-32" onchange="renderHistorical()">
                        <option value="">All</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="ml-auto flex gap-2">
                     <button class="btn btn-ghost btn-sm" onclick="openColumnConfig()"><span class="material-icons text-sm">view_column</span> Columns</button>
                     <button class="btn btn-ghost btn-sm" onclick="copyHistoricalToClipboard()"><span class="material-icons text-sm">content_copy</span> Copy</button>
                </div>
            </div>

            <div class="bg-white rounded shadow-sm overflow-hidden border border-gray-200">
                <table class="data-table">
                    <thead id="historical-thead"></thead>
                    <tbody id="historical-list"></tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<!-- Expanded Editor Modal -->
<div class="expanded-editor-modal" id="expanded-editor-modal">
    <div class="expanded-toolbar">
         <button class="btn btn-ghost" onclick="closeExpandedEditor()"><span class="material-icons">close</span> Close</button>
    </div>
    <div class="expanded-editor-container">
        <div id="expanded-quill-container"></div>
    </div>
</div>

<!-- News Content Pop-up Modal -->
<div class="modal-overlay" id="news-content-modal" onclick="closeNewsPopup(event)" style="z-index: 500;">
    <div class="modal-box" style="width: 700px; max-width: 90%; max-height: 80vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
        <div class="flex justify-between items-start mb-4 border-b pb-2">
            <div id="popup-news-header"></div>
            <button class="btn btn-ghost btn-sm" onclick="closeNewsPopup(null)"><span class="material-icons">close</span></button>
        </div>
        <div id="popup-news-body" class="overflow-y-auto flex-1"></div>
    </div>
</div>

<!-- User Selection Modal -->
<div class="modal-overlay" id="user-select-modal" onclick="closeUserSelect(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h3 class="font-bold text-lg mb-4">Assign User</h3>
        <div class="flex gap-2 mb-3">
            <input type="text" id="user-search-input" placeholder="Search or type name..." class="w-full p-2 border rounded" oninput="filterUserList()">
            <button class="btn btn-primary btn-sm" onclick="assignCustomUser()" title="Use typed name"><span class="material-icons">check</span></button>
        </div>
        <div class="max-h-[200px] overflow-y-auto border rounded divide-y" id="user-select-list"></div>
        <div class="mt-4 flex justify-end">
            <button class="btn btn-ghost btn-sm" onclick="closeUserSelect(null)">Cancel</button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal" onclick="closeSettingsModal(event)">
    <div class="modal-box" style="width: 500px;" onclick="event.stopPropagation()">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="material-icons text-gray-500">settings</span> Approval Levels
        </h3>
        <table class="w-full text-sm border-collapse mb-4">
            <thead>
                <tr class="bg-gray-100 text-left">
                    <th class="p-2 border">Limit Range</th>
                    <th class="p-2 border">Required Workflow</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="p-2 border">< $10M</td><td class="p-2 border">Maker &rarr; Reviewer &rarr; Approver</td></tr>
                <tr><td class="p-2 border">$10M - $50M</td><td class="p-2 border">+ Manager</td></tr>
                <tr><td class="p-2 border">$50M - $100M</td><td class="p-2 border">+ CFO</td></tr>
                <tr><td class="p-2 border">> $100M</td><td class="p-2 border">+ CEO</td></tr>
            </tbody>
        </table>
        <div class="flex justify-end">
            <button class="btn btn-ghost" onclick="closeSettingsModal(null)">Close</button>
        </div>
    </div>
</div>

<!-- Column Config Modal -->
<div class="modal-overlay" id="column-config-modal" onclick="closeColumnConfig(event)">
    <div class="modal-box" style="width: 300px;" onclick="event.stopPropagation()">
        <h3 class="font-bold text-lg mb-4">Column Settings</h3>
        <div id="col-config-list" class="flex flex-col gap-2 mb-4"></div>
        <div class="flex justify-end">
            <button class="btn btn-primary btn-sm" onclick="applyColumnConfig()">Apply</button>
        </div>
    </div>
</div>

<!-- Row Config Modal for Financials -->
<div class="modal-overlay" id="fin-row-config-modal" onclick="fin_closeRowConfig(event)">
    <div class="modal-box" style="width: 700px; max-width: 95%;" onclick="event.stopPropagation()">
        <h3 class="font-bold text-lg mb-4">Financial Row Configuration</h3>
        <div class="text-xs text-gray-500 mb-2">Drag items to reorder. Rename labels as needed.</div>
        <div id="fin-row-config-list" class="flex flex-col gap-2 mb-4 max-h-[500px] overflow-y-auto pr-2"></div>
        <div class="flex justify-end gap-2">
             <button class="btn btn-ghost btn-sm" onclick="fin_closeRowConfig(null)">Cancel</button>
             <button class="btn btn-primary btn-sm" onclick="fin_applyRowConfig()">Apply</button>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal-overlay" id="preview-modal" style="z-index: 300;" onclick="closePreview(event)">
    <div class="bg-white rounded-lg shadow-2xl flex flex-col overflow-hidden w-11/12 h-5/6" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center p-3 border-b bg-gray-50">
            <div class="font-bold flex items-center gap-2">
                <span id="preview-icon" class="material-icons text-blue-500">description</span>
                <span id="preview-filename">File.pdf</span>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="closePreview(null)"><span class="material-icons">close</span></button>
        </div>
        <div id="excel-tabs" class="sheet-tabs hidden"></div>
        <div class="flex-1 bg-gray-100 overflow-auto relative p-4" id="preview-body"></div>
    </div>
</div>

<script>
    // --- Data Model ---
    const USERS = [
        { id: '1001', name: 'Tim Cook', role: 'Maker', avatar: 'TC' },
        { id: '2001', name: 'Jensen Huang', role: 'Reviewer', avatar: 'JH' },
        { id: '3001', name: 'Elon Musk', role: 'Approver', avatar: 'EM' },
        { id: '4001', name: 'Satya Nadella', role: 'Manager', avatar: 'SN' },
        { id: '5001', name: 'Andy Jassy', role: 'CFO', avatar: 'AJ' },
        { id: '6001', name: 'Sundar Pichai', role: 'CEO', avatar: 'SP' },
        { id: '7001', name: 'Mark Zuckerberg', role: 'Reviewer', avatar: 'MZ' },
    ];
    let currentUser = USERS[0];
    let previousView = 'dashboard'; 
    let sourceView = 'dashboard';
    let workflowEditMode = false;
    let editingStepIndex = -1;

    const APPROVAL_MATRIX = [
        { limit: 100000000, roles: ['Maker', 'Reviewer', 'Approver', 'Manager', 'CFO', 'CEO'] },
        { limit: 50000000,  roles: ['Maker', 'Reviewer', 'Approver', 'Manager', 'CFO'] },
        { limit: 10000000,  roles: ['Maker', 'Reviewer', 'Approver', 'Manager'] },
        { limit: 0,         roles: ['Maker', 'Reviewer', 'Approver'] }
    ];

    const WORKFLOW_ROLES = ['Maker', 'Reviewer', 'Approver', 'Manager', 'CFO', 'CEO'];
    
    // Updated CUSTOMER_DB with shares for approx calculation
    const CUSTOMER_DB = {
        'AAPL': { name: 'Apple Inc.', family: 'Apple Grp', region: 'NAM', sector: 'Consumer', domain: 'Technology', am: 'John Sales', creditLine: 50000000, ar: 1200000, util: 2.4, lastRev: '2024-05-01', nextRev: '2025-05-01', id: 'CUST-001', rating: 'AAA', est: '1976', payTerm: 'Net 60', intRating: 'IG1', listed: true, shares: 15.3e9 },
        'NVDA': { name: 'Nvidia Corp.', family: 'Nvidia Grp', region: 'NAM', sector: 'Enterprise', domain: 'Semiconductors', am: 'Sarah Chip', creditLine: 20000000, ar: 15000000, util: 75.0, lastRev: '2024-06-15', nextRev: '2025-06-15', id: 'CUST-002', rating: 'AA+', est: '1993', payTerm: 'Net 45', intRating: 'IG2', listed: true, shares: 2.46e9 },
        'TSLA': { name: 'Tesla Inc.', family: 'Tesla Grp', region: 'NAM', sector: 'Auto', domain: 'Automotive', am: 'Mike Car', creditLine: 15000000, ar: 8000000, util: 53.3, lastRev: '2024-04-10', nextRev: '2025-04-10', id: 'CUST-003', rating: 'BBB', est: '2003', payTerm: 'Net 30', intRating: 'IG4', listed: true, shares: 3.19e9 },
        'MSFT': { name: 'Microsoft Corp.', family: 'MSFT Grp', region: 'NAM', sector: 'Enterprise', domain: 'Technology', am: 'Bill Gates', creditLine: 80000000, ar: 500000, util: 0.6, lastRev: '2024-02-20', nextRev: '2025-02-20', id: 'CUST-004', rating: 'AAA', est: '1975', payTerm: 'Net 60', intRating: 'IG1', listed: true, shares: 7.43e9 },
        'AMZN': { name: 'Amazon.com Inc.', family: 'Amazon Grp', region: 'NAM', sector: 'Consumer', domain: 'E-commerce', am: 'Jeff B', creditLine: 60000000, ar: 30000000, util: 50.0, lastRev: '2024-03-01', nextRev: '2025-03-01', id: 'CUST-005', rating: 'AA', est: '1994', payTerm: 'Net 45', intRating: 'IG2', listed: true, shares: 10.4e9 },
        'GOOGL': { name: 'Alphabet Inc.', family: 'Google Grp', region: 'NAM', sector: 'Internet', domain: 'Technology', am: 'Larry P', creditLine: 55000000, ar: 1000000, util: 1.8, lastRev: '2024-05-15', nextRev: '2025-05-15', id: 'CUST-006', rating: 'AA+', est: '1998', payTerm: 'Net 60', intRating: 'IG2', listed: true, shares: 12.3e9 },
        'META': { name: 'Meta Platforms', family: 'Meta Grp', region: 'NAM', sector: 'Internet', domain: 'Social Media', am: 'Mark Z', creditLine: 30000000, ar: 29000000, util: 96.6, lastRev: '2024-01-10', nextRev: '2025-01-10', id: 'CUST-007', rating: 'A+', est: '2004', payTerm: 'Net 30', intRating: 'IG3', listed: true, shares: 2.54e9 }
    };

    const TICKER_DOMAINS = {
        'AAPL': 'apple.com',
        'NVDA': 'nvidia.com',
        'TSLA': 'tesla.com',
        'MSFT': 'microsoft.com',
        'AMZN': 'amazon.com',
        'GOOGL': 'google.com',
        'META': 'meta.com'
    };

    let requests = [
        {
            id: 'REQ-2025-001', ticker: 'AAPL', name: 'Apple Inc.', status: 'Approved', stepIndex: 5,
            currLimit: 50000000, propLimit: 60000000, purpose: 'Credit Line Change', date: '2025-01-15',
            forecast: 'Q3 Orders expected to rise 20%.', bizDesc: 'Major partner for mobile chipsets.',
            risks: 'Concentration risk high.', mitigants: 'Cash rich entity.', recommendation: 'Approve.',
            files: [],
            finConfig: null, 
            finPeriods: [],
            history: [
                { role: 'Maker', user: 'Tim Cook', status: 'Approved', date: '2025-01-15 09:00' },
                { role: 'Reviewer', user: 'Jensen Huang', status: 'Approved', date: '2025-01-15 11:00' },
                { role: 'Approver', user: 'Elon Musk', status: 'Approved', date: '2025-01-16 10:00' },
                { role: 'Manager', user: 'Satya Nadella', status: 'Approved', date: '2025-01-16 14:00' },
                { role: 'CFO', user: 'Andy Jassy', status: 'Approved', date: '2025-01-17 09:00' },
                { role: 'CEO', user: 'Sundar Pichai', status: 'Approved', date: '2025-01-17 10:00' }
            ],
            isMarketTabHidden: false
        },
        {
            id: 'REQ-2025-003', ticker: 'NVDA', name: 'Nvidia Corp.', status: 'Pending', stepIndex: 2,
            currLimit: 20000000, propLimit: 40000000, purpose: 'New Credit Line', date: '2025-05-10',
            forecast: 'AI chip demand surging.', bizDesc: 'New H100 orders.',
            risks: 'Supply chain constraints.', mitigants: 'Dominant market share.', recommendation: 'Recommended for approval.',
            files: [],
            finConfig: null,
            finPeriods: [],
            history: [
                { role: 'Maker', user: 'Tim Cook', status: 'Approved', date: '2025-05-10 10:00' },
                { role: 'Reviewer', user: 'Jensen Huang', status: 'Approved', date: '2025-05-11 14:00' },
                { role: 'Approver', user: 'Elon Musk', status: 'Pending', date: null },
                { role: 'Manager', user: 'Satya Nadella', status: 'Pending', date: null },
                { role: 'CFO', user: 'Andy Jassy', status: 'Pending', date: null },
                { role: 'CEO', user: 'Sundar Pichai', status: 'Pending', date: null }
            ],
            isMarketTabHidden: false
        },
        {
            id: 'REQ-2025-004', ticker: 'TSLA', name: 'Tesla Inc.', status: 'Returned', stepIndex: 0,
            currLimit: 15000000, propLimit: 25000000, purpose: 'Payment Term Change', date: '2025-05-15',
            forecast: 'EV production ramp up.', bizDesc: 'Global expansion.',
            risks: 'Margin compression.', mitigants: 'Cost cutting.', recommendation: '',
            files: [],
            finConfig: null,
            finPeriods: [],
            history: [
                { role: 'Maker', user: 'Tim Cook', status: 'Pending', date: null },
                { role: 'Reviewer', user: 'Jensen Huang', status: 'Returned', date: '2025-05-16 09:00', comment: 'Please clarify payment terms.' },
                { role: 'Approver', user: 'Elon Musk', status: 'Pending', date: null },
                { role: 'Manager', user: 'Satya Nadella', status: 'Pending', date: null },
                { role: 'CFO', user: 'Andy Jassy', status: 'Pending', date: null },
                { role: 'CEO', user: 'Sundar Pichai', status: 'Pending', date: null }
            ],
            isMarketTabHidden: false
        }
    ];

    let historyConfig = {
        columns: [
            { id: 'id', label: 'Req ID', visible: true },
            { id: 'ticker', label: 'Ticker', visible: true },
            { id: 'company', label: 'Company', visible: true },
            { id: 'purpose', label: 'Purpose', visible: true },
            { id: 'creditLine', label: 'Credit Line', visible: true },
            { id: 'finalDate', label: 'Final Date', visible: true },
            { id: 'approveBy', label: 'Approve by', visible: true },
            { id: 'status', label: 'Status', visible: true }
        ],
        sort: { column: 'finalDate', dir: 'desc' }
    };

    let currentReqId = null;
    let quillForecast, quillBizDesc, quillRisks, quillMitigants, quillRecommendation, quillSummary, quillActionComment, quillPurpose;
    let expandedQuill = null;
    let expandedSourceQuill = null;

    // --- Market Tab Data & Vars ---
    const mkt_tickers = ['NVDA', 'GOOGL', 'AAPL', 'MSFT', 'AMZN', 'META', 'TSLA'];
    const mkt_names = {'NVDA':'Nvidia', 'GOOGL':'Alphabet', 'AAPL':'Apple', 'MSFT':'Microsoft', 'AMZN':'Amazon', 'META':'Meta', 'TSLA':'Tesla'};
    const mkt_colors = {'NVDA':'#76b900', 'GOOGL':'#4285F4', 'AAPL':'#A2AAAD', 'MSFT':'#00A4EF', 'AMZN':'#FF9900', 'META':'#0668E1', 'TSLA':'#E31937'};
    let mkt_dataByTicker = {};
    let mkt_perfData = new Map();
    let mkt_meta = {}; 
    
    // Req Market Tab Specific Vars
    let req_mkt_activeChart = null;
    let req_mkt_currentPeriod = '1Y';
    let req_mkt_news = [];

    // --- Financials Tab Data & Vars ---
    let fin_data = null;
    let fin_currentTicker = 'AAPL';
    let fin_viewType = 'Quarterly';
    let fin_selectedPeriods = []; 
    let fin_rowConfig = []; // Stores user prefs for row visibility/order

    // Customer Master Sorting
    let custSort = { col: 'id', dir: 'asc' };

    // Helper: Parse Metric (B/M/K)
    function parseMetric(val) {
        if (!val) return null;
        if (typeof val === 'number') return val;
        let mult = 1;
        if (val.endsWith('B')) mult = 1e9;
        if (val.endsWith('M')) mult = 1e6;
        if (val.endsWith('K')) mult = 1e3;
        return parseFloat(val.replace(/[BMK,]/g, '')) * mult;
    }

    // Helper: Number Formatting (No Decimals for Financials)
    function formatNumber(num, decimals = 1) {
        if (num === null || num === undefined || isNaN(num)) return '-';
        return num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initQuill();
        initResizer();
        initReqMktResizer();
        renderUserMenu();
        updateNavTabs();
        renderDashboardGreeting();
        renderNotebooks();
        renderCustomerMaster();
        renderHistorical();
        setInterval(renderDashboardGreeting, 60000); 
        
        // Ensure Market Data Loaded
        mkt_loadData();
        
        // Global Click Listener for Dropdowns
        window.onclick = function(event) {
            // User Menu
            if (!event.target.closest('#current-user-avatar') && !event.target.closest('#user-menu')) {
                document.getElementById('user-menu').classList.remove('show');
            }
            
            // Financials Dropdown - Close if click outside wrapper
            if (!event.target.closest('#fin-period-selector')) {
                document.getElementById('fin-period-dropdown-content').classList.remove('show');
            }

            // Purpose Dropdown
             if (!event.target.closest('#purpose-selector')) {
                document.getElementById('purpose-dropdown-content').classList.remove('show');
            }
        }
    });

    function initQuill() {
        const fullToolbarOps = {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            }
        };

        const simpleToolbarOps = {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'color': [] }],
                    ['clean']
                ]
            }
        };

        quillForecast = new Quill('#editor-forecast', fullToolbarOps);
        quillBizDesc = new Quill('#editor-biz-desc', fullToolbarOps);
        quillRisks = new Quill('#editor-risks', fullToolbarOps);
        quillMitigants = new Quill('#editor-mitigants', fullToolbarOps);
        quillRecommendation = new Quill('#editor-recommendation', fullToolbarOps);
        quillActionComment = new Quill('#editor-action-comment', simpleToolbarOps);
        quillSummary = new Quill('#editor-summary', fullToolbarOps);
        quillPurpose = new Quill('#editor-purpose', simpleToolbarOps);

        expandedQuill = new Quill('#expanded-quill-container', fullToolbarOps);
        expandedQuill.on('text-change', () => {
             if(expandedSourceQuill) {
                 expandedSourceQuill.root.innerHTML = expandedQuill.root.innerHTML;
             }
        });

        quillSummary.root.innerHTML = `<p><strong>Business Desc.:</strong></p><p>Insert details here...</p>`;
    }

    // --- Resizer Logic ---
    function initResizer() {
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('workflow-sidebar');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            if(e.target.closest('.sidebar-toggle-divider')) return; 
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = document.body.clientWidth - e.clientX;
            if (newWidth > 0 && newWidth < 800) {
                sidebar.style.width = newWidth + 'px';
                sidebar.classList.remove('collapsed');
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            resizer.classList.remove('resizing');
            document.body.style.cursor = '';
        });

        const vResizer = document.getElementById('vertical-resizer');
        const actionArea = document.getElementById('workflow-actions');
        let isVResizing = false;
        let startY, startActionHeight;

        vResizer.addEventListener('mousedown', (e) => {
            isVResizing = true;
            startY = e.clientY;
            startActionHeight = actionArea.getBoundingClientRect().height;
            document.body.style.cursor = 'row-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isVResizing) return;
            const dy = startY - e.clientY;
            let newHeight = startActionHeight + dy;
            if(newHeight > 100 && newHeight < 600) {
                 actionArea.style.height = newHeight + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isVResizing = false;
            document.body.style.cursor = '';
        });
    }
    
    // --- Req Market Resizer Logic (Updated for flexible split) ---
    function initReqMktResizer() {
        const resizer = document.getElementById('req-mkt-resizer');
        const leftPane = document.getElementById('req-mkt-left-pane');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const container = document.querySelector('.req-mkt-split');
            if(!container) return;
            const containerRect = container.getBoundingClientRect();
            
            let newLeftWidth = e.clientX - containerRect.left;
            
            // Allow full resizing
            if (newLeftWidth > 20 && newLeftWidth < containerRect.width - 20) {
                 leftPane.style.flex = `0 0 ${newLeftWidth}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = '';
        });
    }

    function toggleSidebar() {
        const sb = document.getElementById('workflow-sidebar');
        sb.classList.toggle('collapsed');
        const icon = document.querySelector('.sidebar-toggle-divider span');
        if(sb.classList.contains('collapsed')) {
             sb.style.width = '0';
             icon.innerText = 'chevron_left';
        } else {
             sb.style.width = '380px';
             icon.innerText = 'chevron_right';
        }
    }
    
    function toggleNewsPane(forceShow) {
        const rightPane = document.getElementById('req-mkt-news-list');
        const leftPane = document.getElementById('req-mkt-left-pane');
        
        let shouldHide = false;
        if (forceShow === true) shouldHide = false;
        else if (forceShow === false) shouldHide = true;
        else shouldHide = rightPane.style.display !== 'none';

        if(shouldHide) {
            rightPane.style.display = 'none';
            leftPane.style.flex = '1'; 
        } else {
            rightPane.style.display = 'flex';
            leftPane.style.flex = '0 0 50%'; 
        }
    }

    function updateNavTabs() {
        const container = document.getElementById('main-nav');
        const tabs = [
            { id: 'dashboard', icon: 'dashboard', label: 'Dashboard', roles: ['All'] },
            { id: 'customer-master', icon: 'business', label: 'Customer Master', roles: ['Maker', 'Reviewer'] },
            { id: 'historical', icon: 'history', label: 'History', roles: ['All'] }
        ];

        container.innerHTML = tabs
            .filter(t => t.roles.includes('All') || t.roles.includes(currentUser.role))
            .map(t => `
                <div class="nav-tab ${t.id === 'dashboard' ? 'active' : ''}" data-tab="${t.id}" onclick="navTo('${t.id}')">
                    <span class="material-icons" style="font-size:18px;">${t.icon}</span> ${t.label}
                </div>
            `).join('');
    }

    function navTo(tabId) {
        if (workflowEditMode) toggleWorkflowEditMode(); 
        
        if (currentUser.role === 'Maker' && currentReqId) {
            const req = requests.find(r => r.id === currentReqId);
            if (req && (req.status === 'Draft' || req.status === 'Returned')) {
                commitSave(true);
            }
        }

        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        const tabEl = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
        if(tabEl) tabEl.classList.add('active');

        document.querySelectorAll('.view-section').forEach(v => {
            v.style.display = 'none';
            v.classList.remove('active');
        });
        
        const view = document.getElementById(`view-${tabId}`);
        if(view) {
            view.style.display = 'block';
            setTimeout(() => view.classList.add('active'), 10);
        }

        if(tabId === 'dashboard') renderNotebooks();
        if(tabId === 'historical') renderHistorical();
    }
    
    function handleBackNav() {
        if (currentUser.role === 'Maker') {
            const req = requests.find(r => r.id === currentReqId);
            if (req && (req.status === 'Draft' || req.status === 'Returned')) {
                commitSave(true);
            }
        }
        navTo(sourceView);
    }

    function renderUserMenu() {
        const menu = document.getElementById('user-menu');
        menu.innerHTML = USERS.filter(u => u.id < 9000).map(u => `
            <div class="dropdown-item ${currentUser.id === u.id ? 'active' : ''}" onclick="selectUser('${u.id}')">
                <span>${u.name}</span>
                <span class="text-xs text-gray-400">${u.role}</span>
            </div>
        `).join('');
    }

    function toggleUserMenu(e) {
        if(e) e.stopPropagation();
        document.getElementById('user-menu').classList.toggle('show');
    }

    function selectUser(uid) {
        currentUser = USERS.find(u => u.id === uid);
        document.getElementById('current-user-avatar').innerText = currentUser.avatar;
        document.getElementById('current-user-role').innerText = currentUser.role;
        document.getElementById('user-menu').classList.remove('show');
        
        // BUG FIX 4: Re-render menu to update active class
        renderUserMenu();
        
        workflowEditMode = false;
        document.getElementById('workflow-edit-controls').classList.add('hidden');
        
        currentReqId = null;
        previousView = 'dashboard';
        sourceView = 'dashboard';
        
        updateNavTabs();
        renderDashboardGreeting();
        navTo('dashboard');
    }

    function renderDashboardGreeting() {
        const h = new Date().getHours();
        let greeting = 'Good Morning';
        if(h >= 12) greeting = 'Good Afternoon';
        if(h >= 18) greeting = 'Good Evening';
        document.getElementById('dashboard-greeting').innerText = `${greeting}! ${currentUser.name.split(' ')[0]}`;
    }

    // --- Dashboard ---
    function renderNotebooks() {
        const container = document.getElementById('notebook-container');
        container.innerHTML = '';

        if (currentUser.role === 'Maker') {
            const newCard = document.createElement('div');
            newCard.className = 'notebook-card new-request';
            newCard.innerHTML = `<span class="material-icons" style="font-size:48px;">add_circle_outline</span><div class="mt-2 font-bold">New Request</div>`;
            newCard.onclick = () => createNewRequest();
            container.appendChild(newCard);
        }

        let visibleRequests = requests.filter(req => {
            if (req.status === 'Cancelled' || req.status === 'Approved' || req.status === 'Rejected') return false; 
            
            // Maker sees all they initiated
            if (currentUser.role === 'Maker') return true; 

            // Reviewer sees all (Portfolio tracking)
            if (currentUser.role === 'Reviewer') return true;

            // Approvers (Manager, CFO, CEO) ONLY see requests PENDING at their specific step
            // If they approved it, they no longer see it here.
            if (req.status === 'Pending') {
                const currentStepRole = req.history[req.stepIndex]?.role;
                return currentStepRole === currentUser.role;
            }

            return false;
        });

        visibleRequests.sort((a, b) => {
            const getDate = (req) => {
                const dates = req.history.filter(h => h.date).map(h => new Date(h.date).getTime());
                return dates.length ? Math.max(...dates) : 0;
            };
            return getDate(b) - getDate(a);
        });

        visibleRequests.forEach(req => {
            const isReturned = req.status === 'Returned';
            const isRecalled = req.status === 'Recalled';
            const isMyTurn = req.history[req.stepIndex]?.role === currentUser.role && req.status !== 'Approved';
            
            const currentStepObj = req.history[req.stepIndex];
            const nextApproverText = currentStepObj ? `Next: ${currentStepObj.user} (${currentStepObj.role})` : '';

            // Recall status doesn't get special 'returned' styling (pink), stays neutral/white
            const card = document.createElement('div');
            card.className = `notebook-card ${isReturned ? 'returned' : ''} ${isMyTurn ? 'active-turn' : ''}`;
            
            let deleteBtnHtml = '';
            if (currentUser.role === 'Maker' && req.status === 'Draft') {
                deleteBtnHtml = `<div class="card-delete-btn" onclick="event.stopPropagation(); deleteDraft('${req.id}')"><span class="material-icons" style="font-size:18px;">delete</span></div>`;
            }

            const progressHTML = req.history.map((step, idx) => {
                let statusClass = '';
                if (step.status === 'Approved') statusClass = 'done';
                else if (idx === req.stepIndex) statusClass = 'active';
                else if (step.status === 'Returned') statusClass = 'rejected';
                // Recalled status in history is visually treated neutrally or like draft
                return `<div class="p-bar ${statusClass}"></div>`;
            }).join('');

            const limitText = `$${(req.currLimit/1000000).toFixed(0)}M to $${(req.propLimit/1000000).toFixed(0)}M`;
            
            // Badge Logic
            let badgeClass = 'st-draft';
            if (req.status === 'Pending') badgeClass = 'st-pending';
            else if (req.status === 'Returned') badgeClass = 'st-rejected';
            else if (req.status === 'Recalled') badgeClass = 'st-recalled';

            card.innerHTML = `
                ${deleteBtnHtml}
                <div class="flex justify-between items-start mb-2 pr-6">
                    <h3 class="text-xl font-bold">${req.ticker}</h3>
                    <span class="status-badge ${badgeClass}">
                        ${req.status}
                    </span>
                </div>
                <div class="text-sm text-gray-500 font-bold mb-1">${req.name}</div>
                <div class="text-xs text-gray-400 mb-2">${req.id}</div>
                
                <div class="grid grid-cols-2 gap-2 mb-2 text-sm">
                    <div>
                         <span class="block text-gray-400 text-xs">Limit</span>
                         <span class="font-medium text-gray-700">${limitText}</span>
                    </div>
                    <div>
                         <span class="block text-gray-400 text-xs">Purpose</span>
                         <span class="font-medium text-gray-700 truncate" title="${req.purpose}">${req.purpose}</span>
                    </div>
                </div>
                
                <div class="card-progress-area">
                    <div class="next-approver-label">${nextApproverText}</div>
                    <div class="progress-bars">${progressHTML}</div>
                </div>
            `;
            card.onclick = () => openRequest(req.id, 'dashboard');
            container.appendChild(card);
        });
    }

    // --- Request Detail ---
    function openRequest(reqId, fromView) {
        if(fromView) sourceView = fromView;

        workflowEditMode = false;
        document.getElementById('workflow-edit-controls').classList.add('hidden');

        currentReqId = reqId;
        const req = requests.find(r => r.id === reqId);
        if (!req) return;
        
        // BUG FIX 1: Removed clearRequestMarketTab() from here to allow data persistence.
        
        // REQ 9: Force sidebar to be shown every time entering request
        const sb = document.getElementById('workflow-sidebar');
        sb.classList.remove('collapsed');
        sb.style.width = '380px';
        document.querySelector('.sidebar-toggle-divider span').innerText = 'chevron_right';

        document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
        document.getElementById('view-request-detail').style.display = 'block';
        
        const detailView = document.getElementById('view-request-detail');
        detailView.classList.remove('active');
        void detailView.offsetWidth; 
        detailView.classList.add('active');
        
        // POINT 1: Reset Scroll to Top & Reset to First Tab
        document.getElementById('form-container').scrollTop = 0;
        switchInternalTab('req-form', document.getElementById('tab-req-form'));


        document.getElementById('detail-header-title').innerText = `${req.ticker} - ${req.name}`;

        document.getElementById('frm-ticker').value = req.ticker;
        document.getElementById('frm-name').value = req.name;
        document.getElementById('frm-date').value = req.date || '';
        document.getElementById('frm-curr-limit').value = req.currLimit.toLocaleString();
        document.getElementById('frm-prop-limit').value = parseInt(req.propLimit).toLocaleString();
        
        
        // Manual toggle of visibility without calling handlePurposeChange() to preserve values
        const purposeCheck = req.purpose || '';
        if(purposeCheck.includes('Add New Entity to Share')) {
            document.getElementById('shared-entity-row').classList.remove('hidden');
            document.getElementById('shared-purpose-row').classList.remove('hidden');
        } else {
            document.getElementById('shared-entity-row').classList.add('hidden');
            document.getElementById('shared-purpose-row').classList.add('hidden');
        }
        
        if(req.sharedTickers) document.getElementById('frm-shared-tickers').value = req.sharedTickers;
        if(req.sharedPurpose) document.getElementById('frm-shared-purpose').value = req.sharedPurpose;

        const ptSelect = document.getElementById('frm-payterm-select');
        const cust = CUSTOMER_DB[req.ticker];
        const defaultPT = cust ? cust.payTerm : 'Net 30';
        const knownTerms = ['Net 30', 'Net 60', 'Net 90'];
        const reqTerm = req.paymentTerm || defaultPT;
        
        if(knownTerms.includes(reqTerm)) {
            ptSelect.value = reqTerm;
            document.getElementById('frm-payterm-other').classList.add('hidden');
        } else {
            ptSelect.value = 'Others';
            document.getElementById('frm-payterm-other').classList.remove('hidden');
            document.getElementById('frm-payterm-other').value = reqTerm;
        }

        document.getElementById('rev-header-name').value = req.name;
        document.getElementById('rev-header-date').value = req.date || '';
        document.getElementById('rev-header-parent').value = (req.parentCompany || (cust ? cust.name : '')); 
        document.getElementById('rev-header-shared').value = req.sharedTickers || 'N/A';
        
        if(cust) {
            document.getElementById('rev-code').value = cust.id;
            document.getElementById('rev-region-am').value = `${cust.region} / ${cust.am}`;
            document.getElementById('rev-since').value = cust.est;
            document.getElementById('rev-last-rev').value = cust.lastRev;
            document.getElementById('rev-next-rev').value = cust.nextRev;
            document.getElementById('rev-rating').value = `${cust.intRating} / ${cust.rating}`;
            document.getElementById('rev-credit-line').value = cust.creditLine.toLocaleString();
            document.getElementById('rev-util').value = cust.util + '%';
            document.getElementById('rev-ar').value = cust.ar.toLocaleString();
            document.getElementById('rev-payterm').value = reqTerm;
            document.getElementById('rev-domain').value = cust.domain;
            const listingText = cust.listed ? `Listed (${cust.est})` : 'Private';
            document.getElementById('rev-listed-display').value = listingText;
        }
        
        // BUG FIX 2: Set the dropdown value AFTER toggleInputs, so it persists even if disabled
        const canEditReqForm = currentUser.role === 'Maker' && (req.status === 'Draft' || req.status === 'Returned' || req.status === 'Recalled') && isAtMyStep(req);
        const canEditReviewForm = currentUser.role === 'Reviewer' && isAtMyStep(req);
        
        toggleInputs('pane-req-form', canEditReqForm);
        toggleInputs('pane-review-form', canEditReviewForm);
		
        if(currentUser.role === 'Reviewer' && isAtMyStep(req)) {
             const btn = document.getElementById('btn-purpose-dropdown');
             if(btn) {
                 btn.disabled = false;
                 btn.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
             }
             document.getElementById('frm-type-reason').readOnly = false;
			 document.getElementById('frm-shared-tickers').readOnly = false;
			 document.getElementById('frm-shared-purpose').readOnly = false;
        }
		document.getElementById('rev-risk-subtitle').value = req.riskAnalysisSubtitle || 'Financials as of FYXX ended MM/DD/YYYY';
        document.getElementById('rev-risk-subtitle').readOnly = !canEditReviewForm;
        
        const savedPurpose = req.purpose || 'New Credit Line';
        const selectedPurposes = savedPurpose.split(', ');

        const purposeItems = document.querySelectorAll('#purpose-dropdown-content .dropdown-item-check');
        purposeItems.forEach(item => {
            const text = item.innerText.trim();
            if (selectedPurposes.includes(text)) {
                item.querySelector('.material-icons').innerText = 'check_box';
                item.classList.add('text-blue-600', 'font-medium', 'bg-blue-50');
            } else {
                item.querySelector('.material-icons').innerText = 'check_box_outline_blank';
                item.classList.remove('text-blue-600', 'font-medium', 'bg-blue-50');
            }
        });

        document.getElementById('frm-purpose').value = savedPurpose;

        const pDisplay = document.getElementById('purpose-display');
        if (selectedPurposes.length === 0) pDisplay.innerText = 'Select Purpose';
        else if (selectedPurposes.length === 1) pDisplay.innerText = selectedPurposes[0];
        else pDisplay.innerText = `${selectedPurposes.length} Purposes Selected`;

		document.getElementById('frm-type-reason').value = req.typeReason || '';

        // Reviewer Purpose Editor - Logic: Use Reviewer's saved value OR construct from Maker's
        // This ensures if Reviewer edits it, it persists. If not, it shows Maker's + default text.
        const defaultPurposeText = req.purpose + (req.sharedPurpose ? ` - ${req.sharedPurpose}` : '');
        quillPurpose.root.innerHTML = req.revPurposeVal || defaultPurposeText;

        quillForecast.root.innerHTML = req.forecast || '';
        quillBizDesc.root.innerHTML = req.bizDesc || '';
        quillRisks.root.innerHTML = req.risks || '';
        quillMitigants.root.innerHTML = req.mitigants || '';
        quillRecommendation.root.innerHTML = req.recommendation || '';
        quillActionComment.root.innerHTML = ''; 
        
        if(req.summary) quillSummary.root.innerHTML = req.summary;
        else quillSummary.root.innerHTML = `<p><strong>Business Desc.:</strong></p><p>Insert details here...</p>`;

        document.getElementById('req-prepared-by').value = req.reqPreparedBy || 'Tim Cook';
        document.getElementById('rev-prepared-by').value = req.revPreparedBy || 'Jensen Huang';

        if (canEditReqForm && (req.purpose && req.purpose.includes('New Credit Line'))) {
             document.getElementById('frm-curr-limit').readOnly = true;
        }
        
        const revHeaderInputs = [
            'rev-header-name', 'rev-header-date', 'rev-header-parent', 'rev-header-shared'
        ];
        revHeaderInputs.forEach(id => {
            document.getElementById(id).readOnly = !canEditReviewForm;
        });

        const setQuill = (quill, wrapperId, editable) => {
            quill.enable(editable);
            const wrapper = document.getElementById(wrapperId);
            if(wrapper) {
                const btn = wrapper.querySelector('.editor-expand-btn');
                if(editable) {
                    wrapper.classList.remove('readonly');
                    if(btn) btn.style.display = 'flex';
                } else {
                    wrapper.classList.add('readonly');
                    if(btn) btn.style.display = 'none';
                }
            }
        };

        setQuill(quillForecast, 'wrapper-forecast', canEditReqForm);
        setQuill(quillBizDesc, 'wrapper-biz-desc', canEditReqForm);

        setQuill(quillRisks, 'wrapper-risks', canEditReviewForm);
        setQuill(quillMitigants, 'wrapper-mitigants', canEditReviewForm);
        setQuill(quillRecommendation, 'wrapper-recommendation', canEditReviewForm);
        setQuill(quillPurpose, 'wrapper-purpose', canEditReviewForm);
        
        setQuill(quillSummary, 'wrapper-summary', canEditReviewForm);
        
        setQuill(quillActionComment, 'wrapper-action-comment', (canEditReqForm || canEditReviewForm || isAtMyStep(req))); 

        document.getElementById('req-prepared-by').readOnly = !canEditReqForm;
        document.getElementById('rev-prepared-by').readOnly = !canEditReviewForm;

        const dropZone = document.getElementById('drop-zone');
        if(canEditReqForm) dropZone.classList.remove('hidden');
        else dropZone.classList.add('hidden');

        const revUploadSection = document.getElementById('reviewer-upload-section');
        if(canEditReviewForm) revUploadSection.classList.remove('hidden');
        else revUploadSection.classList.add('hidden');

        renderFileList(req, 'request', 'file-list-area', canEditReqForm);
        renderFileList(req, 'review', 'reviewer-file-list-area', canEditReviewForm);

        const btnEditWf = document.getElementById('btn-edit-workflow');
        if (currentUser.role === 'Reviewer') btnEditWf.classList.remove('hidden');
        else btnEditWf.classList.add('hidden');

        if (canEditReqForm) {
            autoAdjustWorkflow(req);
        }
        
        calculateReviewMarketCap();
        
        // --- Financials Init for this Request ---
        const finControls = document.getElementById('fin-controls-toolbar');
        
        // Only show controls if it is Maker or Reviewer AND it is their turn
        const canEditFinancials = isAtMyStep(req) && (currentUser.role === 'Maker' || currentUser.role === 'Reviewer');
        
        if (canEditFinancials) {
            finControls.style.display = 'flex';
        } else {
            finControls.style.display = 'none';
        }
        
        // Populate Company Name in Header
        document.getElementById('fin-company-display').innerText = req.name || req.ticker;

        // Load the ticker financials
        if (req.ticker) {
            fin_currentTicker = req.ticker;
            fin_loadData(req); 
        }
        
        // --- Render Request Market Tab & Apply Visibility ---
        const mktTab = document.getElementById('tab-market');
        const mktToggleBtn = document.getElementById('btn-toggle-mkt-tab');
        
        // BUG FIX 1 & 2: Only allow toggle if it's Maker/Reviewer AND it is their turn.
        const canEditMarket = isAtMyStep(req); 
        
        if (canEditMarket && (currentUser.role === 'Maker' || currentUser.role === 'Reviewer')) {
             mktToggleBtn.style.display = 'inline-block';
        } else {
             mktToggleBtn.style.display = 'none';
        }

        if(req.ticker) {
            // BUG FIX 3: Always load data if ticker exists, regardless of hidden state
            initRequestMarketTab(req.ticker);
        } else {
            // REQ 4: Empty if no ticker
            clearRequestMarketTab();
            mktTab.style.display = 'none'; // Auto hide if no ticker
        }

        // REQ 1: Update Visuals AFTER initialization, to enforce hidden logic
        updateMarketTabVisuals(req);

        renderWorkflowSidebar(req);
    }
    
    function isAtMyStep(req) {
         return req.history[req.stepIndex] && req.history[req.stepIndex].role === currentUser.role && req.status !== 'Approved';
    }
    
    function updateMarketTabVisuals(req) {
         const mktTab = document.getElementById('tab-market');
         const mktToggleBtn = document.getElementById('btn-toggle-mkt-tab');
         
         // Safety check for data existence
         const hasData = req.ticker && mkt_dataByTicker[req.ticker];
         
         if (!hasData) {
             mktTab.style.display = 'none';
             return;
         }

         if (req.isMarketTabHidden) {
             mktToggleBtn.innerText = 'visibility_off';
             
             // BUG FIX 1 & 3: If user is Maker/Reviewer, show dimmed. Else hide completely.
             if (currentUser.role === 'Maker' || currentUser.role === 'Reviewer') {
                 mktTab.style.display = 'flex';
                 mktTab.classList.add('opacity-50');
             } else {
                 mktTab.style.display = 'none';
             }

             // If currently active and hidden for user, switch away
             if(mktTab.classList.contains('active') && mktTab.style.display === 'none') {
                 switchInternalTab('req-form', document.getElementById('tab-req-form'));
             }
         } else {
             mktTab.classList.remove('opacity-50');
             mktToggleBtn.innerText = 'visibility';
             
             // Ensure visible for everyone if not hidden and ticker exists
             if(req.ticker) mktTab.style.display = 'flex';
         }
    }
    
    function toggleMarketTabVisibility(e) {
        e.stopPropagation();
        const req = requests.find(r => r.id === currentReqId);
        if(!req) return;
        
        // Prevent toggle if button shouldn't be visible/active (double check logic)
        // Button is hidden by display:none, but just in case
        if (!isAtMyStep(req)) return;

        req.isMarketTabHidden = !req.isMarketTabHidden;
        updateMarketTabVisuals(req);
    }
    
    function clearRequestMarketTab() {
        document.getElementById('req-mkt-title').innerText = "Market Data";
        document.getElementById('req-mkt-tbody').innerHTML = '<tr><td colspan="13" class="text-center p-4">No ticker selected.</td></tr>';
        const ctx = document.getElementById('req-mkt-chart-canvas').getContext('2d');
        if(req_mkt_activeChart) {
             req_mkt_activeChart.destroy();
             req_mkt_activeChart = null;
        } else {
             // Clear canvas if no chart instance but canvas has content
             ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }
        document.getElementById('req-mkt-news-content').innerHTML = '';
    }

    function toggleInputs(containerId, enable) {
        const container = document.getElementById(containerId);
        const inputs = container.querySelectorAll('input, select');
        inputs.forEach(inp => {
            if(inp.parentElement.classList.contains('mcap-cell')) return; 
            if(inp.id.includes('prepared-by')) return;
            if(inp.id.includes('rev-header-')) return; 

            inp.readOnly = !enable;
            if(inp.tagName === 'SELECT') inp.disabled = !enable;
        });

        const dropdownBtns = container.querySelectorAll('.multi-select-dropdown .dropdown-btn');
        dropdownBtns.forEach(btn => {
            btn.disabled = !enable;
            if(!enable) btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
            else btn.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
        });
    }

    function openExpandedEditor(wrapperId) {
        let sourceQuill;
        if(wrapperId === 'wrapper-forecast') sourceQuill = quillForecast;
        else if(wrapperId === 'wrapper-biz-desc') sourceQuill = quillBizDesc;
        else if(wrapperId === 'wrapper-risks') sourceQuill = quillRisks;
        else if(wrapperId === 'wrapper-mitigants') sourceQuill = quillMitigants;
        else if(wrapperId === 'wrapper-recommendation') sourceQuill = quillRecommendation;
        else if(wrapperId === 'wrapper-purpose') sourceQuill = quillPurpose;
        else if(wrapperId === 'wrapper-summary') sourceQuill = quillSummary;
        else if(wrapperId === 'wrapper-action-comment') sourceQuill = quillActionComment;

        if(sourceQuill) {
            expandedSourceQuill = sourceQuill;
            document.getElementById('expanded-editor-modal').style.display = 'flex';
            expandedQuill.root.innerHTML = sourceQuill.root.innerHTML;
            expandedQuill.setSelection(0);
            expandedQuill.focus();
        }
    }

    function closeExpandedEditor() {
        document.getElementById('expanded-editor-modal').style.display = 'none';
        if(expandedSourceQuill) {
             expandedSourceQuill.root.innerHTML = expandedQuill.root.innerHTML;
             expandedSourceQuill = null;
        }
    }

    function handleLimitChange() {
        const req = requests.find(r => r.id === currentReqId);
        if(!req) return;
        
        const isMakerDraft = currentUser.role === 'Maker' && (req.status === 'Draft' || req.status === 'Returned' || req.status === 'Recalled');
        
        if (isMakerDraft) {
    		req.propLimit = parseInt(document.getElementById('frm-prop-limit').value.replace(/,/g, '')) || 0;
    		autoAdjustWorkflow(req);
        }
    }

    function togglePurposeDropdown() {
        const btn = document.getElementById('btn-purpose-dropdown');
        if(!btn.disabled) {
             document.getElementById('purpose-dropdown-content').classList.toggle('show');
        }
    }

    function togglePurpose(value, element) {
        // Prevent toggle if disabled (though click shouldn't reach here if dropdown hidden, but safety check)
        const btn = document.getElementById('btn-purpose-dropdown');
        if(btn.disabled) return;

        let currentVal = document.getElementById('frm-purpose').value;
        let selected = currentVal ? currentVal.split(', ') : [];

        if (selected.includes(value)) {
            selected = selected.filter(v => v !== value);
            element.querySelector('.material-icons').innerText = 'check_box_outline_blank';
            element.classList.remove('text-blue-600', 'font-medium', 'bg-blue-50');
        } else {
            selected.push(value);
            element.querySelector('.material-icons').innerText = 'check_box';
            element.classList.add('text-blue-600', 'font-medium', 'bg-blue-50');
        }

        // Update Hidden Input
        document.getElementById('frm-purpose').value = selected.join(', ');

        // Update Button Text
        const display = document.getElementById('purpose-display');
        if (selected.length === 0) display.innerText = 'Select Purpose';
        else if (selected.length === 1) display.innerText = selected[0];
        else display.innerText = `${selected.length} Purposes Selected`;

        // Trigger Change Logic
        handlePurposeChange();
    }

    function autoAdjustWorkflow(req) {
        const limit = parseInt(req.propLimit) || 0;
        const requiredRule = APPROVAL_MATRIX.find(r => limit >= r.limit) || APPROVAL_MATRIX[APPROVAL_MATRIX.length-1];
        const requiredRoles = requiredRule.roles; 

        const newHistory = [];
        newHistory.push(req.history[0]);

        for (let i = 1; i < requiredRoles.length; i++) {
            const role = requiredRoles[i];
            const existingStep = req.history.slice(1).find(step => step.role === role);
            
            if (existingStep) {
                newHistory.push(existingStep);
            } else {
                const defaultUser = USERS.find(u => u.role === role);
                newHistory.push({ 
                    role: role, 
                    user: defaultUser ? defaultUser.name : 'Unknown', 
                    status: 'Pending', 
                    date: null 
                });
            }
        }
        req.history = newHistory;
        renderWorkflowSidebar(req);
    }

    function handlePurposeChange() {
        const valStr = document.getElementById('frm-purpose').value;
        const selected = valStr ? valStr.split(', ') : [];

        const req = requests.find(r => r.id === currentReqId);
        const isEdit = currentUser.role === 'Maker' && (req.status === 'Draft' || req.status === 'Returned' || req.status === 'Recalled');

        if (isEdit) {
            const ticker = document.getElementById('frm-ticker').value;
            const cust = CUSTOMER_DB[ticker];
            
            if(selected.includes('New Credit Line')) {
                document.getElementById('frm-curr-limit').value = 0;
                document.getElementById('frm-curr-limit').readOnly = true;
                req.currLimit = 0;
            } else if (selected.includes('Credit Line Change')) {
                if(cust) {
                     document.getElementById('frm-curr-limit').value = cust.creditLine.toLocaleString();
                     req.currLimit = cust.creditLine;
                }
                document.getElementById('frm-curr-limit').readOnly = false;
            } else {
                // Bug 3 Fix: Pre-fill and Default for others
                // Only if something is selected, or we default to maintenance mode?
                // If nothing selected, we probably shouldn't overwrite unless we want a default state.
                // Assuming "else" implies "Payment Term Change" or "Add New Entity" or empty (but usually one is selected).
                if(cust && selected.length > 0) {
                     const limitStr = cust.creditLine.toLocaleString();
                     document.getElementById('frm-curr-limit').value = limitStr;
                     document.getElementById('frm-prop-limit').value = limitStr;
                     req.currLimit = cust.creditLine;
                     req.propLimit = cust.creditLine;
                }
                document.getElementById('frm-curr-limit').readOnly = false;
            }
            handleLimitChange();
        }

        if(selected.includes('Add New Entity to Share')) {
            document.getElementById('shared-entity-row').classList.remove('hidden');
            document.getElementById('shared-purpose-row').classList.remove('hidden');
        } else {
            document.getElementById('shared-entity-row').classList.add('hidden');
            document.getElementById('shared-purpose-row').classList.add('hidden');
        }
    }

    function handlePayTermChange() {
        const val = document.getElementById('frm-payterm-select').value;
        const otherInput = document.getElementById('frm-payterm-other');
        if(val === 'Others') otherInput.classList.remove('hidden');
        else otherInput.classList.add('hidden');
    }

    function handleTickerInput(input) {
        const val = input.value.toUpperCase();
        const cust = CUSTOMER_DB[val];
        const req = requests.find(r => r.id === currentReqId);
        
        if (cust) {
            document.getElementById('frm-name').value = cust.name;
            
            // Bug 3 Fix: Apply same logic on ticker change
            const purpose = document.getElementById('frm-purpose').value;
            if(!purpose.includes('New Credit Line')) {
                const limitStr = cust.creditLine.toLocaleString();
                document.getElementById('frm-curr-limit').value = limitStr;
                
                // Also default prop limit for these specific types
                // But logic is trickier with multi select. Assume if not New/Change line, we default prop limit.
                if (!purpose.includes('Credit Line Change')) {
                    document.getElementById('frm-prop-limit').value = limitStr;
                } else {
                    // For Credit Line Change, default to current
                    document.getElementById('frm-prop-limit').value = limitStr;
                }
                
    			// Fix: Update the req model as well
    			if (req) {
    			    req.currLimit = cust.creditLine;
    			    req.propLimit = cust.creditLine; // Default prop to current
    			}
    			handleLimitChange();
            }
            
            // Trigger financial & market load on ticker change if Maker
            if (currentUser.role === 'Maker') {
                fin_currentTicker = val;
                fin_loadData(req);
                req.ticker = val; // ensure req has ticker for market tab
                req.isMarketTabHidden = false; // Reset hidden state
                updateMarketTabVisuals(req);
                initRequestMarketTab(val);
                document.getElementById('tab-market').style.display = 'flex';
            }
        } 
    }

    // --- File Upload Logic ---
    function handleDragOver(e) {
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e, category) {
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files, category);
    }

    function handleFileSelect(e, category) {
        const files = e.target.files;
        handleFiles(files, category);
    }

    function handleFiles(fileList, category) {
        const req = requests.find(r => r.id === currentReqId);
        if(!req.files) req.files = [];
        
        Array.from(fileList).forEach(f => {
            const reader = new FileReader();
            let type = 'pdf';
            if(f.name.endsWith('.xls') || f.name.endsWith('.xlsx')) type = 'xls';
            if(f.name.endsWith('.doc') || f.name.endsWith('.docx')) type = 'doc';

            reader.onload = function(e) {
                req.files.push({ name: f.name, type: type, data: e.target.result, category: category || 'request' });
                const canEditReq = currentUser.role === 'Maker'; 
                const canEditRev = currentUser.role === 'Reviewer';
                renderFileList(req, 'request', 'file-list-area', canEditReq);
                renderFileList(req, 'review', 'reviewer-file-list-area', canEditRev);
            };
            
            if(type === 'xls') reader.readAsArrayBuffer(f);
            else if (type === 'doc') reader.readAsArrayBuffer(f);
            else reader.readAsDataURL(f);
        });
    }

    function renderFileList(req, category, containerId, canEdit) {
        const container = document.getElementById(containerId);
        if(!container) return;
        
        const filteredFiles = (req.files || []).filter(f => (f.category || 'request') === category);
        
        container.innerHTML = filteredFiles.map((f, index) => {
            const mainIndex = req.files.indexOf(f);
            
            let icon = 'description';
            let color = 'text-gray-500';
            if(f.type === 'pdf') { icon = 'picture_as_pdf'; color = 'text-red-500'; }
            if(f.type === 'xls') { icon = 'table_chart'; color = 'text-green-600'; }
            if(f.type === 'doc') { icon = 'article'; color = 'text-blue-600'; }
            
            const deleteBtn = canEdit ? 
                `<span class="material-icons text-gray-400 hover:text-red-500 cursor-pointer ml-auto file-delete-btn" style="font-size:18px;" onclick="event.stopPropagation(); deleteFile(${mainIndex}, '${category}', '${containerId}')">close</span>` : '';

            return `
            <div class="flex items-center gap-2 p-2 border rounded bg-gray-50 cursor-pointer hover:bg-blue-50 transition w-full sm:w-auto"
                 onclick="openFilePreview(${mainIndex})">
                <span class="material-icons ${color}" style="font-size:20px;">${icon}</span>
                <span class="text-sm font-medium underline text-blue-700 truncate" style="max-width:150px;">${f.name}</span>
                ${deleteBtn}
            </div>
        `}).join('');
    }

    function deleteFile(index, category, containerId) {
        if(confirm('Delete this file?')) {
            const req = requests.find(r => r.id === currentReqId);
            req.files.splice(index, 1);
            const canEdit = (category === 'request' && currentUser.role === 'Maker') || (category === 'review' && currentUser.role === 'Reviewer');
            renderFileList(req, category, containerId, canEdit);
        }
    }

    let currentWorkbook = null;

    function openFilePreview(fileIndex) {
        const req = requests.find(r => r.id === currentReqId);
        const file = req.files[fileIndex];
        if(!file) return;

        const modal = document.getElementById('preview-modal');
        const body = document.getElementById('preview-body');
        const title = document.getElementById('preview-filename');
        const icon = document.getElementById('preview-icon');
        const tabsContainer = document.getElementById('excel-tabs');

        title.innerText = file.name;
        modal.style.display = 'flex';
        body.innerHTML = '<div class="text-gray-500">Loading preview...</div>';
        
        tabsContainer.innerHTML = '';
        tabsContainer.classList.add('hidden');

        if(file.type === 'pdf') {
            icon.innerText = 'picture_as_pdf';
            icon.className = 'material-icons text-red-500';
            body.innerHTML = `<iframe src="${file.data}" width="100%" height="100%" style="border:none;"></iframe>`;
        } else if (file.type === 'xls') {
            icon.innerText = 'table_chart';
            icon.className = 'material-icons text-green-600';
            try {
                currentWorkbook = XLSX.read(file.data, {type: 'array'});
                if(currentWorkbook.SheetNames.length > 0) {
                    tabsContainer.classList.remove('hidden');
                    currentWorkbook.SheetNames.forEach((sheetName, idx) => {
                        const tab = document.createElement('div');
                        tab.className = `sheet-tab ${idx === 0 ? 'active' : ''}`;
                        tab.innerText = sheetName;
                        tab.onclick = () => renderSheet(sheetName);
                        tabsContainer.appendChild(tab);
                    });
                    renderSheet(currentWorkbook.SheetNames[0]);
                }
            } catch(e) {
                body.innerHTML = '<div class="text-red-500">Error parsing Excel file. Ensure it is a valid .xlsx file.</div>';
            }
        } else if (file.type === 'doc') {
            icon.innerText = 'article';
            icon.className = 'material-icons text-blue-600';
            mammoth.convertToHtml({arrayBuffer: file.data})
                .then(function(result){
                    body.innerHTML = `<div style="background:white; padding:40px; width:100%; max-width:800px; margin:0 auto; box-shadow:0 0 10px rgba(0,0,0,0.1); min-height:100%; overflow:auto;">${result.value}</div>`;
                })
                .catch(function(err){
                    body.innerHTML = '<div class="text-red-500">Error parsing Word file. Ensure it is a valid .docx file.</div>';
                });
        }
    }

    function renderSheet(sheetName) {
        const body = document.getElementById('preview-body');
        const sheet = currentWorkbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
        if(!json || json.length === 0) {
            body.innerHTML = '<div class="p-4 text-gray-500">Empty Sheet</div>';
            return;
        }
        let maxCols = 0;
        json.forEach(row => { if(row.length > maxCols) maxCols = row.length; });
        const getColName = (n) => {
            let s = "";
            while(n >= 0) {
                s = String.fromCharCode(n % 26 + 65) + s;
                n = Math.floor(n / 26) - 1;
            }
            return s;
        };
        let html = '<table class="excel-table">';
        html += '<tr><th class="excel-row-num"></th>'; 
        for(let i=0; i<maxCols; i++) {
            html += `<th class="excel-header">${getColName(i)}</th>`;
        }
        html += '</tr>';
        json.forEach((row, rowIndex) => {
            html += `<tr><td class="excel-row-num">${rowIndex + 1}</td>`;
            for(let i=0; i<maxCols; i++) {
                const cellVal = row[i] !== undefined ? row[i] : "";
                html += `<td>${cellVal}</td>`;
            }
            html += '</tr>';
        });
        html += '</table>';
        body.innerHTML = `<div style="background:white; padding:20px; min-height:100%; width:fit-content; min-width:100%; box-shadow:0 0 5px rgba(0,0,0,0.05);">${html}</div>`;
        document.querySelectorAll('.sheet-tab').forEach(t => {
            if(t.innerText === sheetName) t.classList.add('active');
            else t.classList.remove('active');
        });
    }

    function closePreview(e) {
        if (!e || e.target.id === 'preview-modal' || e.target.closest('.btn-ghost')) document.getElementById('preview-modal').style.display = 'none';
    }

    function toggleWorkflowEditMode() {
        workflowEditMode = !workflowEditMode;
        const controls = document.getElementById('workflow-edit-controls');
        if(workflowEditMode) controls.classList.remove('hidden');
        else controls.classList.add('hidden');
        
        const req = requests.find(r => r.id === currentReqId);
        renderWorkflowSidebar(req);
    }

    function addWorkflowStep() {
        const req = requests.find(r => r.id === currentReqId);
        req.history.push({ role: 'Reviewer', user: 'New User', status: 'Pending', date: null });
        renderWorkflowSidebar(req);
    }

    function removeWorkflowStep(idx) {
        const req = requests.find(r => r.id === currentReqId);
        if(idx <= req.stepIndex) return alert("Cannot remove completed or active steps.");
        req.history.splice(idx, 1);
        renderWorkflowSidebar(req);
    }
    
    function moveStep(idx, direction) {
        const req = requests.find(r => r.id === currentReqId);
        const targetIdx = idx + direction;
        if(idx <= req.stepIndex || targetIdx <= req.stepIndex) return; 
        if(targetIdx >= req.history.length) return;

        const temp = req.history[idx];
        req.history[idx] = req.history[targetIdx];
        req.history[targetIdx] = temp;
        renderWorkflowSidebar(req);
    }

    function openUserAssignModal(idx) {
        if(!workflowEditMode && currentUser.role !== 'Reviewer') return; 
        editingStepIndex = idx;
        const modal = document.getElementById('user-select-modal');
        modal.style.display = 'flex';
        document.getElementById('user-search-input').value = '';
        filterUserList(); 
    }

    function closeUserSelect(e) {
        if(!e || e.target.id === 'user-select-modal' || e.target.closest('.btn-ghost')) {
            document.getElementById('user-select-modal').style.display = 'none';
        }
    }

    function filterUserList() {
        const search = document.getElementById('user-search-input').value.toLowerCase();
        const list = document.getElementById('user-select-list');
        const allUsers = [...USERS, {id:'9999', name:'Zack External', role:'Consultant', avatar:'Z'}];
        
        list.innerHTML = allUsers.filter(u => u.name.toLowerCase().includes(search)).map(u => `
            <div class="p-2 hover:bg-gray-100 cursor-pointer flex justify-between" onclick="assignUser('${u.name}')">
                <span>${u.name}</span>
                <span class="text-xs text-gray-500">${u.role}</span>
            </div>
        `).join('');
    }

    function assignUser(userName) {
        commitAssign(userName);
    }

    function assignCustomUser() {
        const inputVal = document.getElementById('user-search-input').value.trim();
        if(inputVal) commitAssign(inputVal);
    }

    function commitAssign(userName) {
        const req = requests.find(r => r.id === currentReqId);
        if(editingStepIndex > -1 && req.history[editingStepIndex]) {
            req.history[editingStepIndex].user = userName;
            if(editingStepIndex === req.stepIndex) req.history[editingStepIndex].comment = `(Reassigned to ${userName})`;
            renderWorkflowSidebar(req);
        }
        document.getElementById('user-select-modal').style.display = 'none';
    }

    function validateWorkflow(req) {
        const limit = parseInt(req.propLimit) || 0;
        const requiredRule = APPROVAL_MATRIX.find(r => limit >= r.limit) || APPROVAL_MATRIX[APPROVAL_MATRIX.length-1];
        const missing = requiredRule.roles.filter(role => !req.history.some(h => h.role === role));
        if(missing.length > 0) {
            return `Warning: The workflow is missing mandatory roles for this amount: ${missing.join(', ')}.`;
        }
        return null;
    }

    function renderWorkflowSidebar(req) {
        const list = document.getElementById('workflow-list');
        list.innerHTML = req.history.map((step, idx) => {
            let icon = 'radio_button_unchecked';
            let colorClass = 'text-gray-400';

            if (step.status === 'Approved') { icon = 'check_circle'; colorClass = 'text-green-600'; }
            if (step.status === 'Returned') { icon = 'cancel'; colorClass = 'text-red-600'; }
            if (step.status === 'Cancelled') { icon = 'block'; colorClass = 'text-gray-500'; }
            if (idx === req.stepIndex && req.status !== 'Approved' && req.status !== 'Cancelled') { icon = 'play_circle_filled'; colorClass = 'text-blue-600'; }

            let actionsHtml = '';
            const canEdit = workflowEditMode && idx > req.stepIndex; 
            const canDelegate = currentUser.role === 'Reviewer' && idx >= req.stepIndex && step.status === 'Pending';
            
            if(canEdit || canDelegate) {
                 actionsHtml += `<span class="delegation-btn" onclick="openUserAssignModal(${idx})">Assign</span>`;
            }

            if(workflowEditMode && idx > req.stepIndex) {
                actionsHtml += `<span class="material-icons wf-control-btn" onclick="moveStep(${idx}, -1)">arrow_upward</span>`;
                actionsHtml += `<span class="material-icons wf-control-btn" onclick="moveStep(${idx}, 1)">arrow_downward</span>`;
                actionsHtml += `<span class="material-icons wf-control-btn wf-delete-btn" onclick="removeWorkflowStep(${idx})">close</span>`;
            }

            return `
                <div class="wf-item">
                    <div class="wf-icon"><span class="material-icons ${colorClass}">${icon}</span></div>
                    <div class="wf-details">
                        <div class="wf-role">
                            <span>${step.role}</span>
                            <div class="flex items-center">${actionsHtml}</div>
                        </div>
                        <div class="wf-meta">${step.user}</div>
                        ${step.date ? `<div class="wf-time">${step.date}</div>` : ''}
                        ${step.comment ? `<div class="wf-comment">"${step.comment}"</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');

        const currentStepRole = req.history[req.stepIndex] ? req.history[req.stepIndex].role : '';
        const actionArea = document.getElementById('workflow-actions');
        
        const makerButtons = document.getElementById('maker-action-buttons');
        const standardButtons = document.getElementById('standard-action-buttons');
        const recallArea = document.getElementById('recall-button-area');

        document.getElementById('return-confirm-area').classList.add('hidden');
        document.getElementById('return-options').classList.add('hidden');
        makerButtons.classList.add('hidden');
        standardButtons.classList.add('flex');
        standardButtons.classList.remove('hidden');
        recallArea.classList.add('hidden');

        // Logic for Active Action Buttons
        if (currentUser.role === currentStepRole && req.status !== 'Approved' && req.status !== 'Cancelled') {
            actionArea.style.display = 'block';
            
            if (currentUser.role === 'Maker') {
                standardButtons.classList.add('hidden'); 
                if(req.status === 'Returned' || req.status === 'Recalled') {
                    makerButtons.classList.remove('hidden');
                    makerButtons.classList.add('flex');
                } else {
                    standardButtons.classList.remove('hidden');
                    document.getElementById('btn-approve').innerText = 'Submit Application';
                    document.getElementById('btn-return').style.display = 'none';
                }
            } else {
                document.getElementById('btn-approve').innerText = 'Approve';
                document.getElementById('btn-return').style.display = 'inline-flex';
                document.getElementById('btn-return').innerText = 'Return';
            }
        } else {
            // Recall Logic
            // Allowed if user is the immediately preceding step
            // And request is pending
            
            let canRecall = false;
            if (req.status === 'Pending' && req.stepIndex > 0) {
                 const prevStep = req.history[req.stepIndex - 1];
                 // Check if current user is the user of previous step
                 if (prevStep && prevStep.user === currentUser.name) {
                     canRecall = true;
                 }
            }

            if (canRecall) {
                actionArea.style.display = 'block';
                standardButtons.classList.add('hidden');
                makerButtons.classList.add('hidden');
                document.getElementById('comment-section-wrapper').classList.add('hidden'); 
                recallArea.classList.remove('hidden');
            } else {
                actionArea.style.display = 'none';
            }
        }
        
        // Ensure comment section visible if active step
        if (currentUser.role === currentStepRole && req.status !== 'Approved') {
            document.getElementById('comment-section-wrapper').classList.remove('hidden');
        }
    }

    function openSettingsModal() {
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettingsModal(e) {
        if(!e || e.target.id === 'settings-modal' || e.target.closest('.btn-ghost')) {
            document.getElementById('settings-modal').style.display = 'none';
        }
    }

    // --- Action Logic ---
    let returnMode = false;

    function toggleReturnMode() {
        returnMode = true;
        document.getElementById('standard-action-buttons').classList.add('hidden');
        document.getElementById('return-confirm-area').classList.remove('hidden');
        document.getElementById('return-options').classList.remove('hidden');

        const req = requests.find(r => r.id === currentReqId);
        const select = document.getElementById('return-target-step');
        select.innerHTML = '';
        
        const optMaker = document.createElement('option');
        optMaker.value = 0;
        optMaker.text = "Maker (Tim Cook)";
        select.appendChild(optMaker);

        for(let i=1; i < req.stepIndex; i++) {
            const step = req.history[i];
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = `${step.role} (${step.user})`;
            select.appendChild(opt);
        }
    }

    function cancelReturnMode() {
        returnMode = false;
        document.getElementById('standard-action-buttons').classList.remove('hidden');
        document.getElementById('return-confirm-area').classList.add('hidden');
        document.getElementById('return-options').classList.add('hidden');
    }

    function processAction(action) {
        const req = requests.find(r => r.id === currentReqId);
        
        if(action === 'approve') {
            const warning = validateWorkflow(req);
            if(warning) {
                if(!confirm(warning + "\n\nDo you still want to proceed?")) return;
            }
        }

        const step = req.history[req.stepIndex];
        const commentText = quillActionComment.getText().trim();
        
        const now = new Date();
        const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

        if (action === 'approve') {
            if(currentUser.role === 'Maker' && !document.getElementById('frm-ticker').value) return alert('Ticker is required');
            
            step.comment = commentText ? commentText : ''; 
            step.status = 'Approved';
            step.date = timestamp;
            
            if (req.stepIndex < req.history.length - 1) {
                req.stepIndex++;
                req.status = 'Pending';
                req.history[req.stepIndex].status = 'Pending';
            } else {
                req.status = 'Approved';
            }
        } else {
            step.status = 'Returned';
            step.date = timestamp;
            step.comment = commentText ? commentText : 'Returned';
            
            const returnTargetIndex = parseInt(document.getElementById('return-target-step').value || 0);
            req.stepIndex = returnTargetIndex;
            req.status = 'Returned';
            req.history[returnTargetIndex].status = 'Pending'; 
            
            cancelReturnMode();
        }

        // Bug Fix 1: Ensure req.purpose doesn't get polluted
        if (currentUser.role === 'Maker') {
             // Redundant check since commitSave handles it, but good for safety
             const pSelect = document.getElementById('frm-purpose');
             if(pSelect) req.purpose = pSelect.value;
        }

        commitSave(true); 

        quillActionComment.root.innerHTML = '';
        renderWorkflowSidebar(req);
        handleBackNav(); 
    }
    
    function recallRequest() {
        if(!confirm('Are you sure you want to recall this request? It will be returned to your step.')) return;
        
        const req = requests.find(r => r.id === currentReqId);
        
        // Recall goes back to the previous step (current user)
        const targetStep = req.stepIndex - 1;
        
        const now = new Date();
        const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

        // Add history note to current pending step that it was recalled
        const currentPendingStep = req.history[req.stepIndex];
        currentPendingStep.comment = `(Recalled by ${currentUser.name})`;
        currentPendingStep.date = timestamp;
        
        req.stepIndex = targetStep;
        req.status = 'Recalled'; // Changed from Returned to Recalled for different styling
        req.history[targetStep].status = 'Pending';
        
        commitSave(true);
        handleBackNav();
    }

    function cancelRequest() {
         if(confirm('Cancel this returned request? It will be moved to history.')) {
            const req = requests.find(r => r.id === currentReqId);
            req.status = 'Cancelled';
            const now = new Date();
            req.history.push({ role: 'Maker', user: currentUser.name, status: 'Cancelled', date: now.toLocaleString(), comment: 'Cancelled by Maker' });
            handleBackNav();
         }
    }

    function createNewRequest() {
        const newId = `REQ-2025-${requests.length+1}`.padStart(3,'0');
        const newReq = {
            id: newId, ticker: '', name: '', status: 'Draft', stepIndex: 0,
            currLimit: 0, propLimit: 0, purpose: 'New Credit Line', date: new Date().toISOString().split('T')[0],
            typeReason: '', riskAnalysisSubtitle: '',
			forecast: '', bizDesc: '', risks: '', mitigants: '', recommendation: '', summary: '', files: [],
            finConfig: null,
            finPeriods: [],
            history: WORKFLOW_ROLES.map(role => ({ role, user: USERS.find(u=>u.role===role).name, status: 'Pending', date: null })),
            isMarketTabHidden: false
        };
        newReq.history[0].status = 'Pending';
        requests.push(newReq);
        
        autoAdjustWorkflow(newReq);
        
        renderNotebooks();
    }
    
    function commitSave(silent) {
        const req = requests.find(r => r.id === currentReqId);
        if(req) {
             if (currentUser.role === 'Maker') {
                 req.ticker = document.getElementById('frm-ticker').value;
                 req.name = document.getElementById('frm-name').value;
                 req.propLimit = parseInt(document.getElementById('frm-prop-limit').value.replace(/,/g, '')) || 0;
                 req.currLimit = parseInt(document.getElementById('frm-curr-limit').value.replace(/,/g,'')) || 0;
                 req.date = document.getElementById('frm-date').value;
                 
                 // Bug Fix 1: Strictly set purpose from dropdown value only
                 req.purpose = document.getElementById('frm-purpose').value;
                 req.typeReason = document.getElementById('frm-type-reason').value;
                 
                 if(req.purpose.includes('Add New Entity to Share')) {
                     req.sharedTickers = document.getElementById('frm-shared-tickers').value;
                     req.sharedPurpose = document.getElementById('frm-shared-purpose').value;
                 }
                 
                 const ptVal = document.getElementById('frm-payterm-select').value;
                 req.paymentTerm = (ptVal === 'Others') ? document.getElementById('frm-payterm-other').value : ptVal;

                 req.forecast = quillForecast.root.innerHTML;
                 req.bizDesc = quillBizDesc.root.innerHTML;
                 req.reqPreparedBy = document.getElementById('req-prepared-by').value;
                 
                 autoAdjustWorkflow(req);
             } else if (currentUser.role === 'Reviewer') {
                 req.risks = quillRisks.root.innerHTML;
                 req.mitigants = quillMitigants.root.innerHTML;
                 req.recommendation = quillRecommendation.root.innerHTML;
                 // Bug Fix 2 & 3: Save Reviewer's Purpose editor content to separate field
                 // Do NOT overwrite req.purpose
                 req.revPurposeVal = quillPurpose.root.innerHTML;
                 req.purpose = document.getElementById('frm-purpose').value;
                 req.typeReason = document.getElementById('frm-type-reason').value;
				 req.sharedTickers = document.getElementById('frm-shared-tickers').value;
                 req.sharedPurpose = document.getElementById('frm-shared-purpose').value;
              
                 req.riskAnalysisSubtitle = document.getElementById('rev-risk-subtitle').value;

                 req.summary = quillSummary.root.innerHTML; 
                 req.revPreparedBy = document.getElementById('rev-prepared-by').value;
                 
                 req.name = document.getElementById('rev-header-name').value; 
                 req.date = document.getElementById('rev-header-date').value;
                 req.parentCompany = document.getElementById('rev-header-parent').value;
                 req.sharedTickers = document.getElementById('rev-header-shared').value;
             }

             if (!silent) alert('Saved!');
        }
    }

    function saveDraft() {
        commitSave(false);
    }

    function deleteDraft(targetId) {
        if(confirm('Are you sure you want to delete this draft?')) {
            requests = requests.filter(r => r.id !== targetId);
            renderNotebooks();
        }
    }

    // --- Helpers ---
    function switchInternalTab(paneId, tabEl) {
        document.querySelectorAll('.internal-tab').forEach(t => t.classList.remove('active'));
        if(tabEl) tabEl.classList.add('active');
        document.querySelectorAll('.internal-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(`pane-${paneId}`).classList.add('active');
    }

    function sortCustomerMaster(colId) {
        if(custSort.col === colId) custSort.dir = custSort.dir === 'asc' ? 'desc' : 'asc';
        else { custSort.col = colId; custSort.dir = 'asc'; }
        
        renderCustomerMaster();
    }

    function renderCustomerMaster() {
        const tbody = document.getElementById('master-table-body');
        const list = Object.entries(CUSTOMER_DB).map(([ticker, c]) => ({...c, ticker}));
        
        // Apply Sort
        list.sort((a,b) => {
            let valA = a[custSort.col] || a['ticker']; // fallback for id vs ticker naming
            let valB = b[custSort.col] || b['ticker'];
            
            if (custSort.col === 'id') { valA = a.ticker; valB = b.ticker; }
            else if (custSort.col === 'creditLine' || custSort.col === 'ar' || custSort.col === 'util') {
                valA = parseFloat(valA) || 0; valB = parseFloat(valB) || 0;
            } else {
                valA = (valA || '').toString().toLowerCase();
                valB = (valB || '').toString().toLowerCase();
            }
            
            if(valA > valB) return custSort.dir === 'asc' ? 1 : -1;
            if(valA < valB) return custSort.dir === 'asc' ? -1 : 1;
            return 0;
        });

        const iconHtml = custSort.dir === 'asc' ? 'arrow_drop_up' : 'arrow_drop_down';
        
        // Update headers to reset icons then set correct one
        document.querySelectorAll('.data-table th span').forEach(sp => sp.innerText = 'unfold_more');
        const targetTh = document.querySelector(`.data-table th[onclick="sortCustomerMaster('${custSort.col}')"] span`);
        if(targetTh) targetTh.innerText = iconHtml;

        tbody.innerHTML = list.map(c => `
            <tr>
                <td class="font-bold">${c.ticker}</td><td>${c.name}</td><td>${c.family}</td><td>${c.region}</td>
                <td>${c.sector}</td><td>${c.domain}</td><td>${c.am}</td>
                <td>$${(c.creditLine/1000000).toFixed(1)}M</td><td>$${(c.ar/1000000).toFixed(1)}M</td>
                <td>${c.util}%</td><td>${c.lastRev}</td>
            </tr>
        `).join('');
    }

    function renderHistorical() {
        const thead = document.getElementById('historical-thead');
        const tbody = document.getElementById('historical-list');
        const fTicker = document.getElementById('hist-filter-ticker').value.toLowerCase();
        const fPurpose = document.getElementById('hist-filter-purpose').value;
        const fStatus = document.getElementById('hist-filter-status').value;

        let data = requests.map(r => {
             const lastStep = r.history.filter(h => h.status !== 'Pending').pop() || r.history[r.history.length-1];
             return {
                 id: r.id,
                 ticker: r.ticker,
                 company: r.name,
                 purpose: r.purpose,
                 creditLine: parseInt(r.propLimit),
                 finalDate: lastStep.date || '-',
                 approveBy: lastStep.user,
                 status: r.status,
                 rawObj: r
             };
        });

        data = data.filter(d => {
            if(fTicker && !d.ticker.toLowerCase().includes(fTicker)) return false;
            if(fPurpose && d.purpose !== fPurpose) return false;
            if(fStatus && d.status !== fStatus) return false;
            return true;
        });

        const sortCol = historyConfig.sort.column;
        const sortDir = historyConfig.sort.dir;
        
        data.sort((a,b) => {
            let valA = a[sortCol];
            let valB = b[sortCol];
            if(typeof valA === 'string') valA = valA.toLowerCase();
            if(typeof valB === 'string') valB = valB.toLowerCase();
            
            if(valA < valB) return sortDir === 'asc' ? -1 : 1;
            if(valA > valB) return sortDir === 'asc' ? 1 : -1;
            return 0;
        });

        let headerHtml = '<tr>';
        historyConfig.columns.forEach(col => {
            if(!col.visible) return;
            const sortIcon = (col.id === sortCol) ? (sortDir==='asc'?'arrow_drop_up':'arrow_drop_down') : '';
            headerHtml += `<th onclick="sortHistorical('${col.id}')">${col.label} <span class="material-icons align-middle text-sm">${sortIcon}</span></th>`;
        });
        headerHtml += '<th>Action</th></tr>';
        thead.innerHTML = headerHtml;

        if(data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${historyConfig.columns.filter(c=>c.visible).length + 1}" class="p-4 text-center text-gray-500">No records found.</td></tr>`;
        } else {
            tbody.innerHTML = data.map(row => {
                let rowHtml = `<tr class="cursor-pointer" onclick="openRequest('${row.id}', 'historical')">`;
                historyConfig.columns.forEach(col => {
                    if(!col.visible) return;
                    let val = row[col.id];
                    if(col.id === 'creditLine') val = '$' + val.toLocaleString();
                    if(col.id === 'status') val = `<span class="status-badge ${val==='Approved'?'st-approved':(val==='Rejected'?'st-rejected':(val==='Cancelled'?'st-cancelled':'st-draft'))}">${val}</span>`;
                    rowHtml += `<td>${val}</td>`;
                });
                rowHtml += `<td><button class="btn btn-ghost btn-sm text-xs">View</button></td></tr>`;
                return rowHtml;
            }).join('');
        }
    }

    function sortHistorical(columnId) {
        if(historyConfig.sort.column === columnId) {
            historyConfig.sort.dir = historyConfig.sort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            historyConfig.sort.column = columnId;
            historyConfig.sort.dir = 'desc'; 
        }
        renderHistorical();
    }

    function openColumnConfig() {
        const modal = document.getElementById('column-config-modal');
        const list = document.getElementById('col-config-list');
        list.innerHTML = historyConfig.columns.map((col, idx) => `
            <div class="flex items-center gap-2 p-1 border-b">
                <input type="checkbox" id="col-cb-${col.id}" ${col.visible ? 'checked' : ''}>
                <label for="col-cb-${col.id}" class="flex-1 text-sm">${col.label}</label>
                <span class="material-icons cursor-pointer text-gray-400 text-sm hover:text-black" onclick="moveColConfig(${idx}, -1)">arrow_upward</span>
                <span class="material-icons cursor-pointer text-gray-400 text-sm hover:text-black" onclick="moveColConfig(${idx}, 1)">arrow_downward</span>
            </div>
        `).join('');
        modal.style.display = 'flex';
    }
    
    function moveColConfig(idx, dir) {
        const target = idx + dir;
        if(target < 0 || target >= historyConfig.columns.length) return;
        const temp = historyConfig.columns[idx];
        historyConfig.columns[idx] = historyConfig.columns[target];
        historyConfig.columns[target] = temp;
        openColumnConfig(); 
    }

    function applyColumnConfig() {
        historyConfig.columns.forEach(col => {
            const cb = document.getElementById(`col-cb-${col.id}`);
            if(cb) col.visible = cb.checked;
        });
        document.getElementById('column-config-modal').style.display = 'none';
        renderHistorical();
    }

    function closeColumnConfig(e) {
        if (!e || e.target.id === 'column-config-modal') document.getElementById('column-config-modal').style.display = 'none';
    }

    function copyHistoricalToClipboard() {
        const thead = document.getElementById('historical-thead');
        const tbody = document.getElementById('historical-list');
        let text = [];
        let headers = [];
        thead.querySelectorAll('th').forEach(th => {
            if(th.innerText !== 'Action') headers.push(th.innerText.replace('arrow_drop_down','').replace('arrow_drop_up','').trim());
        });
        text.push(headers.join('\t'));
        tbody.querySelectorAll('tr').forEach(tr => {
            let row = [];
            tr.querySelectorAll('td').forEach((td, i) => {
                if (i < tr.children.length - 1) row.push(td.innerText.trim());
            });
            text.push(row.join('\t'));
        });
        const finalText = text.join('\n');
        navigator.clipboard.writeText(finalText).then(() => {
            alert('Table copied to clipboard!');
        });
    }

    // --- Market Tab Logic (Data Loading - Global) ---
    function getLogoHtml(ticker) {
        const domain = TICKER_DOMAINS[ticker];
        if (!domain) return '';
        return `<img src="https://getlogo.dev/logos/${domain}?token=pub_97e0e4df192f20dd2626307d2148f88d" style="width:20px; height:20px; vertical-align:middle; margin-right:8px; border-radius:50%; object-fit:contain; background:white;" onerror="this.style.display='none'">`;
    }

    async function mkt_loadData() {
         try {
             const res = await fetch('https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/market_data/US_Stocks.json');
             if(!res.ok) throw new Error("Data fetch failed");
             const json = await res.json();
             
             mkt_tickers.forEach(ticker => {
                 // REQ 1: TSLA Fix. Check if source uses TSLA.O
                 let rawKey = ticker;
                 if (ticker === 'TSLA') rawKey = 'TSLA.O';
                 else if (!json[ticker] && json[ticker + '.O']) rawKey = ticker + '.O';
                 else if (ticker.includes('.')) rawKey = ticker;
                 else rawKey = ticker + '.O'; // default fallback for most in this dataset

                 const rawData = json[rawKey] || json[ticker]; // Try logic then fallback to direct
                 
                 if(rawData && rawData.date && rawData.close) {
                     // Store Meta
                     mkt_meta[ticker] = { shares: parseMetric(rawData.sharesOutstanding) };

                     const clean = [];
                     rawData.date.forEach((dStr, i) => {
                         if(!dStr.includes('T') && rawData.close[i] != null) {
                             clean.push({ date: new Date(dStr), price: rawData.close[i] });
                         }
                     });
                     mkt_dataByTicker[ticker] = clean;
                     
                     // Calc Perf with "Find Price On Or Before" logic
                     const findPrice = (d) => {
                         const target = d.getTime();
                         for(let i=clean.length-1; i>=0; i--) {
                             if(clean[i].date.getTime() <= target) return clean[i].price;
                         }
                         return null;
                     };
                     const calc = (p1, p2) => ((p2/p1)-1)*100;
                     mkt_perfData.set(ticker, { findPrice, calc, data: clean });
                 }
             });
         } catch(e) {
             console.error("Market Data Error", e);
         }
    }
    
    // --- New: Specific Request Market Tab Rendering ---
    function initRequestMarketTab(ticker) {
        const mktTab = document.getElementById('tab-market');
        const req = requests.find(r => r.id === currentReqId);
        
        // REQ 8: If ticker not found, hide tab.
        if(!ticker || !mkt_dataByTicker[ticker]) {
            mktTab.style.display = 'none';
            // Also if active, switch away
            if(mktTab.classList.contains('active')) switchInternalTab('req-form', document.getElementById('tab-req-form'));
            return;
        }
        
        // Removed explicit mktTab.style.display = 'flex' here.
        // Visibility is now fully controlled by updateMarketTabVisuals called in openRequest.

        // REQ 2: Update Title
        const coName = CUSTOMER_DB[ticker] ? CUSTOMER_DB[ticker].name : ticker;
        document.getElementById('req-mkt-title').innerText = `${coName}'s Share Price & News`;
        
        // REQ 3: Set As Of Date (Default to Today or Req Date if set?)
        // Usually "As of Date" implies looking at the past. Default to Today if not set.
        if(!document.getElementById('req-mkt-as-of-date').value) {
             document.getElementById('req-mkt-as-of-date').value = new Date().toISOString().split('T')[0];
        }

        req_mkt_refreshAll(ticker);
    }
    
    function req_mkt_refreshAll(tickerOverride) {
        const req = requests.find(r => r.id === currentReqId);
        const ticker = tickerOverride || (req ? req.ticker : null);
        if(!ticker) return;

        req_mkt_renderSummaryRow(ticker);
        req_mkt_updateChart(req_mkt_currentPeriod, ticker);
        req_mkt_loadNews(ticker);
    }

    function req_mkt_renderSummaryRow(ticker) {
        const perf = mkt_perfData.get(ticker);
        if(!perf) return;

        const dateVal = document.getElementById('req-mkt-as-of-date').value;
        const refDate = dateVal ? new Date(dateVal) : new Date();

        // Find data point <= refDate
        let currPoint = null;
        for(let i=perf.data.length-1; i>=0; i--) {
            if(perf.data[i].date <= refDate) {
                currPoint = perf.data[i];
                break;
            }
        }
        
        if(!currPoint) {
            document.getElementById('req-mkt-tbody').innerHTML = '<tr><td colspan="13" class="text-center p-4">No data available for selected date.</td></tr>';
            return;
        }

        const currPrice = currPoint.price;
        const effectiveDate = currPoint.date;

        // Market Cap
        let mcap = '-';
        const shares = mkt_meta[ticker] ? mkt_meta[ticker].shares : 0;
        if(shares && currPrice) {
            const val = currPrice * shares;
            mcap = (val / 1e9).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + 'B';
        }

        const getRet = (period) => {
            let d = new Date(effectiveDate);
            if(period==='1-Day') {
                 const idx = perf.data.findIndex(p => p.date.getTime() === effectiveDate.getTime());
                 if (idx > 0) return perf.calc(perf.data[idx-1].price, currPrice);
                 return -999;
            }
            if(period==='1-Week') d.setDate(d.getDate()-7);
            else if(period==='1-Month') d.setMonth(d.getMonth()-1);
            else if(period==='3-Month') d.setMonth(d.getMonth()-3);
            else if(period==='6-Month') d.setMonth(d.getMonth()-6);
            else if(period==='YTD') d = new Date(d.getFullYear(),0,1);
            else if(period==='1-Year') d.setFullYear(d.getFullYear()-1);
            else if(period==='2-Year') d.setFullYear(d.getFullYear()-2);
            
            const p0 = perf.findPrice(d);
            if(!p0) return -999;
            return perf.calc(p0, currPrice);
        };

        const dateStr = `${effectiveDate.getDate()}/${effectiveDate.toLocaleString('en-US', {month:'short'})}`;
        
        // REQ 5: Columns 1D, 1W, 1M, 3M, 6M, YTD, 1Y, 2Y
        const rowHtml = `
            <tr>
                <td class="font-bold text-gray-700">${mkt_names[ticker] || ticker}</td>
                <td><span style="color:black; font-weight:bold; font-size:0.75rem;">${ticker}</span></td>
                <td>${dateStr}</td>
                <td>${mcap}</td>
                <td>${formatNumber(currPrice)}</td>
                <td class="${getRet('1-Day')>=0?'text-positive':'text-negative'}">${getRet('1-Day')!==-999?formatNumber(getRet('1-Day'))+'%':'-'}</td>
                <td class="${getRet('1-Week')>=0?'text-positive':'text-negative'}">${getRet('1-Week')!==-999?formatNumber(getRet('1-Week'))+'%':'-'}</td>
                <td class="${getRet('1-Month')>=0?'text-positive':'text-negative'}">${getRet('1-Month')!==-999?formatNumber(getRet('1-Month'))+'%':'-'}</td>
                <td class="${getRet('3-Month')>=0?'text-positive':'text-negative'}">${getRet('3-Month')!==-999?formatNumber(getRet('3-Month'))+'%':'-'}</td>
                <td class="${getRet('6-Month')>=0?'text-positive':'text-negative'}">${getRet('6-Month')!==-999?formatNumber(getRet('6-Month'))+'%':'-'}</td>
                <td class="${getRet('YTD')>=0?'text-positive':'text-negative'}">${getRet('YTD')!==-999?formatNumber(getRet('YTD'))+'%':'-'}</td>
                <td class="${getRet('1-Year')>=0?'text-positive':'text-negative'}">${getRet('1-Year')!==-999?formatNumber(getRet('1-Year'))+'%':'-'}</td>
                <td class="${getRet('2-Year')>=0?'text-positive':'text-negative'}">${getRet('2-Year')!==-999?formatNumber(getRet('2-Year'))+'%':'-'}</td>
            </tr>
        `;
        document.getElementById('req-mkt-tbody').innerHTML = rowHtml;
    }

    function req_mkt_updateChart(period, tickerOverride) {
        req_mkt_currentPeriod = period;
        document.querySelectorAll('#req-mkt-chart-controls .chart-period-btn').forEach(btn => {
            if(btn.dataset.period === period) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        const ctx = document.getElementById('req-mkt-chart-canvas').getContext('2d');
        if(req_mkt_activeChart) req_mkt_activeChart.destroy();
        
        const req = requests.find(r => r.id === currentReqId);
        const ticker = tickerOverride || (req ? req.ticker : null);
        if(!ticker || !mkt_dataByTicker[ticker]) return;

        const dateVal = document.getElementById('req-mkt-as-of-date').value;
        const refDate = dateVal ? new Date(dateVal) : new Date();

        const data = mkt_dataByTicker[ticker];
        
        // Filter out future data relative to refDate
        const historicData = data.filter(p => p.date <= refDate);
        if(historicData.length === 0) return;

        let start;
        const end = refDate;
        
        // Calc start date based on refDate
        if(period === '1M') start = new Date(new Date(refDate).setMonth(refDate.getMonth()-1));
        else if(period === '3M') start = new Date(new Date(refDate).setMonth(refDate.getMonth()-3));
        else if(period === '6M') start = new Date(new Date(refDate).setMonth(refDate.getMonth()-6));
        else if(period === 'YTD') start = new Date(refDate.getFullYear(), 0, 1);
        else if(period === '1Y') start = new Date(new Date(refDate).setFullYear(refDate.getFullYear()-1));
        else if(period === '2Y') start = new Date(new Date(refDate).setFullYear(refDate.getFullYear()-2));
        
        const filtered = historicData.filter(p => p.date >= start);
        
        // REQ 6: Black Line, MMM/yy Format
        req_mkt_activeChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Price',
                    data: filtered.map(p => ({x: p.date, y: p.price})),
                    borderColor: '#000000', // REQ 6: Black
                    borderWidth: 1.5,
                    pointRadius: 0,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'time', 
                        time: { 
                            unit: 'month',
                            displayFormats: { month: 'MMM/yy' } // REQ 6: MMM/yy
                        },
                        ticks: {
                            maxRotation: 0, // REQ 6: Horizontal
                            autoSkip: true,
                            autoSkipPadding: 15
                        },
                        grid: { display: true, color: '#f3f4f6' } // REQ 3: Restore Grid
                    },
                    y: {
                         grid: { color: '#f3f4f6' }
                    }
                },
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
            }
        });
    }

    async function req_mkt_loadNews(ticker) {
        const listEl = document.getElementById('req-mkt-news-content');
        listEl.innerHTML = '<p class="p-4 text-gray-500">Loading specific news...</p>';
        
        const dateVal = document.getElementById('req-mkt-as-of-date').value;
        const refDate = dateVal ? new Date(dateVal) : new Date();

        try {
            const res = await fetch(`https://raw.githubusercontent.com/andychu221/reuters-news-archive/main/taiwan-stock-news/${ticker}.json`);
            if(!res.ok) throw new Error("News not found");
            const json = await res.json();
            
            if(json && json.news) {
                // Process Dates & Filter by refDate
                let newsItems = json.news.map(n => { 
                    n.jsDate = new Date(n.Date + ' ' + (n.Time||'')); 
                    return n;
                });
                
                // Filter news happening on or before refDate (plus one day to cover time diffs)
                const cutoff = new Date(refDate);
                cutoff.setDate(cutoff.getDate() + 1);
                
                newsItems = newsItems.filter(n => n.jsDate < cutoff);
                newsItems.sort((a,b) => b.jsDate - a.jsDate);
                
                if (newsItems.length === 0) {
                     listEl.innerHTML = '<p class="p-4">No news found before selected date.</p>';
                     return;
                }

                listEl.innerHTML = newsItems.slice(0, 50).map((n, i) => `
                    <div class="news-item" onclick='showNewsPopup(${JSON.stringify(n).replace(/'/g, "&#39;")})'>
                        <div class="news-meta">
                             <span>${n.Date}</span>
                             <span class="ml-auto">${n.Source || ''}</span>
                        </div>
                        <div class="news-title">${n.Title}</div>
                    </div>
                `).join('');
            } else {
                listEl.innerHTML = '<p class="p-4">No news found.</p>';
            }
        } catch(e) {
            listEl.innerHTML = '<p class="p-4 text-gray-400">Unable to load news for this ticker.</p>';
        }
    }

    function showNewsPopup(item) {
        const modal = document.getElementById('news-content-modal');
        const header = document.getElementById('popup-news-header');
        const body = document.getElementById('popup-news-body');
        
        header.innerHTML = `
            <div class="font-bold text-xl">${item.Title}</div>
            <div class="text-sm text-gray-500 mt-1">${item.Date} ${item.Time||''} | ${item.Source || 'Unknown'}</div>
        `;
        
        body.innerHTML = `
            <div class="text-base leading-relaxed whitespace-pre-wrap p-2">${item.Content || 'No content.'}</div>
            <div class="mt-4 border-t pt-2"><a href="${item.URL}" target="_blank" class="text-blue-600 hover:underline text-sm font-bold">Read Original <span class="material-icons text-xs align-middle">open_in_new</span></a></div>
        `;
        
        modal.style.display = 'flex';
    }

    function closeNewsPopup(e) {
        if (!e || e.target.id === 'news-content-modal' || e.target.closest('.btn-ghost')) {
            document.getElementById('news-content-modal').style.display = 'none';
        }
    }

    // --- Custom Period Modal Logic ---
    function mkt_openCustomPeriodModal() {
        document.getElementById('mkt-summary-custom-start').value = mkt_customStart.toISOString().split('T')[0];
        document.getElementById('mkt-summary-custom-end').value = mkt_customEnd.toISOString().split('T')[0];
        document.getElementById('custom-period-modal').style.display = 'flex';
    }

    function mkt_closeCustomPeriodModal(e) {
        if(!e || e.target.id === 'custom-period-modal') {
            document.getElementById('custom-period-modal').style.display = 'none';
        }
    }

    function mkt_applyCustomPeriod() {
        const sVal = document.getElementById('mkt-summary-custom-start').value;
        const eVal = document.getElementById('mkt-summary-custom-end').value;
        if(sVal && eVal) {
            mkt_customStart = new Date(sVal);
            mkt_customEnd = new Date(eVal);
            // Re-render would happen here in original, now not critical for per-req view without customization
            document.getElementById('custom-period-modal').style.display = 'none';
        }
    }

    // --- Review Form Auto Calculation ---
    function calculateReviewMarketCap() {
        const dateStr = document.getElementById('rev-header-date').value;
        const req = requests.find(r => r.id === currentReqId);
        if(!req || !dateStr) return;
        const ticker = req.ticker;
        
        const cust = CUSTOMER_DB[ticker];
        const shares = cust ? cust.shares : 0;
        
        let histData = mkt_dataByTicker[ticker];
        if(!histData) return; 
        
        const targetDate = new Date(dateStr);
        const targetTime = targetDate.getTime();
        let priceOnDate = 0;
        
        const sorted = histData.sort((a,b) => a.date - b.date);
		let dateOfPrice = null;

        for(let i=sorted.length-1; i>=0; i--) {
            if(sorted[i].date.getTime() <= targetTime) {
                priceOnDate = sorted[i].price;
				dateOfPrice = sorted[i].date;
                break;
            }
        }
        
        if(!priceOnDate) return;

		const fmtDate = (d) => `(${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()})`;

        // Point 2: Market Cap in B (and thousand separator)
        let mcapValue = (priceOnDate * shares / 1e9);
        let mcapFormatted = mcapValue.toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + 'B'; 

		document.getElementById('mcap-curr').innerHTML = `<div class="font-bold">$${mcapFormatted}</div><div class="text-[10px] text-gray-500">${fmtDate(dateOfPrice)}</div>`;
        
        const lookbackDate = new Date(targetDate);
        lookbackDate.setDate(lookbackDate.getDate() - 250);
        
        const rangeData = sorted.filter(p => p.date >= lookbackDate && p.date <= targetDate);
        if(rangeData.length > 0) {
            let maxP = -Infinity, minP = Infinity;
            let maxD = null, minD = null;
			rangeData.forEach(p => {
                if(p.price > maxP) { maxP = p.price; maxD = p.date; }
                if(p.price < minP) { minP = p.price; minD = p.date; }
            });
        	let highMcap = (maxP * shares / 1e9).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + 'B';
            let lowMcap = (minP * shares / 1e9).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + 'B';
            
            document.getElementById('mcap-high').innerHTML = `<div class="font-bold">$${highMcap}</div><div class="text-[10px] text-gray-500">${fmtDate(maxD)}</div>`;
			document.getElementById('mcap-low').innerHTML = `<div class="font-bold">$${lowMcap}</div><div class="text-[10px] text-gray-500">${fmtDate(minD)}</div>`;
            
        }
    }

    // --- Financials Tab Logic ---
    function fin_init() {
        // init handled within openRequest or global load
    }
    
    // --- New Financials Period Selector Logic ---
    function fin_togglePeriodDropdown() {
        document.getElementById('fin-period-dropdown-content').classList.toggle('show');
    }

    function fin_updatePeriodSelector() {
        // Filter available periods based on mode
        const modeFilter = fin_viewType === 'Quarterly' ? 'Q' : 'FY';
        let availablePeriods = [];
        
        if (fin_data) {
            // Extract all unique periods that match the mode
            const allPeriods = [...new Set(fin_data.map(d => d.period))];
            availablePeriods = allPeriods.filter(p => p.includes(modeFilter));
            
            // Sort periods descending
            availablePeriods.sort((a, b) => {
                const parseP = (p) => {
                    const parts = p.split(' ');
                    const year = parseInt(parts[1]);
                    let sub = 0;
                    if(parts[0].startsWith('Q')) sub = parseInt(parts[0].substring(1));
                    return year * 100 + sub;
                };
                return parseP(b) - parseP(a);
            });
        }

        // If no periods selected yet (e.g. first load), select top 4
        if (fin_selectedPeriods.length === 0) {
             fin_selectedPeriods = availablePeriods.slice(0, 5);
        }

        // Render Dropdown List (Content Only)
        const listContainer = document.getElementById('fin-period-list');
        listContainer.innerHTML = availablePeriods.map(p => `
            <div class="dropdown-item-check ${fin_selectedPeriods.includes(p) ? 'selected' : ''}" onclick="fin_togglePeriod('${p}', this)">
                <span class="material-icons text-sm">${fin_selectedPeriods.includes(p) ? 'check_box' : 'check_box_outline_blank'}</span>
                ${p}
            </div>
        `).join('');

        // Update Label
        document.getElementById('fin-period-label').innerText = `${fin_selectedPeriods.length} Periods Selected`;
        
        // Render Table if data exists
        if(fin_data) fin_renderTable();
    }

    function fin_togglePeriod(period, element) {
        // Toggle selection state in array
        if (fin_selectedPeriods.includes(period)) {
            fin_selectedPeriods = fin_selectedPeriods.filter(p => p !== period);
            element.classList.remove('selected');
            element.querySelector('.material-icons').innerText = 'check_box_outline_blank';
        } else {
            fin_selectedPeriods.push(period);
            element.classList.add('selected');
            element.querySelector('.material-icons').innerText = 'check_box';
        }
        
        // Re-sort selected periods to maintain chronological order for display
        fin_selectedPeriods.sort((a, b) => {
             const parseP = (p) => {
                const parts = p.split(' ');
                const year = parseInt(parts[1]);
                let sub = 0;
                if(parts[0].startsWith('Q')) sub = parseInt(parts[0].substring(1));
                return year * 100 + sub;
            };
            return parseP(b) - parseP(a);
        });
        
        // Don't render table yet, wait for Done
        document.getElementById('fin-period-label').innerText = `${fin_selectedPeriods.length} Periods Selected`;
    }
    
    function fin_confirmPeriods() {
        document.getElementById('fin-period-dropdown-content').classList.remove('show');
        fin_renderTable();
    }
    
    function fin_setPeriodMode(mode) {
        fin_viewType = mode;
        document.getElementById('btn-fin-ann').classList.toggle('active-mode-yellow', mode === 'Annual');
        document.getElementById('btn-fin-qtr').classList.toggle('active-mode-yellow', mode === 'Quarterly');
        
        // Re-init dropdown based on new mode
        fin_selectedPeriods = []; // Reset selections on mode switch
        fin_updatePeriodSelector();
    }

    async function fin_loadData(req) {
        if(!fin_currentTicker) return; 
        
        const container = document.getElementById('fin-table-container');
        container.innerHTML = '<div class="p-8 text-center text-gray-500">Loading Financials for ' + fin_currentTicker + '...</div>';
        
        try {
            const res = await fetch(`https://raw.githubusercontent.com/andychu221/yhfinance-fred-data/main/us_financials/${fin_currentTicker}.json`);
            if(!res.ok) throw new Error("Failed to load financials");
            const json = await res.json();
            fin_data = json.data;
            
            // Check if Request has saved config, if so load it
            if(req && req.finConfig) {
                 fin_rowConfig = req.finConfig;
            } else {
                 fin_rowConfig = []; // Reset or Default
            }
            
            if(req && req.finPeriods && req.finPeriods.length > 0) {
                 fin_selectedPeriods = req.finPeriods;
            } else {
                 fin_selectedPeriods = []; // IMPORTANT: Clear selection if no saved periods for this request
            }

            // Init selector after data load
            fin_updatePeriodSelector();
            
        } catch(e) {
            console.error(e);
            container.innerHTML = '<div class="p-8 text-center text-red-500">Error loading financial data (Ticker might not be in database).</div>';
        }
    }

    // --- Enhanced Summary Calculation ---
    function fin_getGrowth(data, currentPeriod, label) {
        // Logic: Find current val, find previous period val.
        const currVal = findValue(data, currentPeriod, label);
        if(currVal === null) return null;

        const parts = currentPeriod.split(' ');
        const year = parseInt(parts[1]);
        let prevPeriod = '';
        
        // Q: compare to PREVIOUS Q in sequence (QoQ)
        // FY: compare to PREVIOUS FY (YoY)
        if(parts[0] === 'FY') {
            prevPeriod = `FY ${year - 1}`;
        } else if (parts[0].startsWith('Q')) {
             const qNum = parseInt(parts[0].substring(1)); // 1, 2, 3, 4
             if (qNum === 1) {
                 prevPeriod = `Q4 ${year - 1}`;
             } else {
                 prevPeriod = `Q${qNum - 1} ${year}`;
             }
        }
        
        const prevVal = findValue(data, prevPeriod, label);
        if(prevVal === null || prevVal === 0) return null;
        
        return ((currVal - prevVal) / Math.abs(prevVal)) * 100;
    }
    
    // Returns ALL potential rows from IS/BS/CF + Summary Metrics for Configuration
    function fin_getAllPotentialRows() {
         if(!fin_data) return [];
         
         // New Structure: IS -> BS -> CF
         const newDefaults = [
            // Income Statement
            { label: 'Income Statement', isHeader: true, order: -30, group: 'Income Statement' },
            { label: 'Total Revenue', search: 'Total Revenue', depth: 1, order: -29, group: 'Income Statement' },
            { label: 'Revenue Growth %', calc: 'growth', target: 'Total Revenue', isRatio: true, order: -28, depth: 2, group: 'Income Statement' },
            { label: 'Gross Profit', search: 'Gross Profit', depth: 1, order: -27, group: 'Income Statement' },
            { label: 'Gross Margin %', calc: 'ratio', num: 'Gross Profit', den: 'Total Revenue', isRatio: true, order: -26, depth: 2, group: 'Income Statement' },
            { label: 'Operating Income', search: 'Operating Income (Loss)', depth: 1, order: -25, group: 'Income Statement' },
            { label: 'Operating Margin %', calc: 'ratio', num: 'Operating Income (Loss)', den: 'Total Revenue', isRatio: true, order: -24, depth: 2, group: 'Income Statement' },
            { label: 'Net Profit', search: 'Net Income (Loss) Attributable to Parent', depth: 1, order: -23, group: 'Income Statement' },
            { label: 'Net Profit Margin %', calc: 'ratio', num: 'Net Income (Loss) Attributable to Parent', den: 'Total Revenue', isRatio: true, order: -22, depth: 2, group: 'Income Statement' },
            { label: 'Basic EPS', search: 'Earnings Per Share, Basic', depth: 1, order: -21, isEPS: true, group: 'Income Statement' },
            { label: 'EPS Growth %', calc: 'growth', target: 'Earnings Per Share, Basic', isRatio: true, order: -20, depth: 2, group: 'Income Statement' },

            // Balance Sheet
            { label: 'Balance Sheet', isHeader: true, order: -10, group: 'Balance Sheet' },
            { label: 'Cash & Equivalents', search: 'Cash and Cash Equivalents, at Carrying Value', depth: 1, order: -9, group: 'Balance Sheet' },
            { label: 'Total Debt', search: 'Long-term Debt', depth: 1, order: -8, group: 'Balance Sheet' },
            { label: 'Total Assets', search: 'Assets', depth: 1, order: -7, group: 'Balance Sheet' },
            { label: 'Total Liabilities', search: 'Liabilities', depth: 1, order: -6, group: 'Balance Sheet' },
            { label: 'Quick Ratio %', calc: 'quick_ratio', isRatio: true, depth: 1, order: -5, group: 'Balance Sheet' },
            { label: 'AR Days', calc: 'ar_days', isRatio: false, depth: 1, order: -4, group: 'Balance Sheet' },

            // Cash Flow
            { label: 'Cash Flow', isHeader: true, order: 0, group: 'Cash Flow' },
            { label: 'Cash From Operating Activities', search: 'Net Cash Provided by (Used in) Operating Activities', depth: 1, order: 1, group: 'Cash Flow' },
            { label: 'Cash From Investing Activities', search: 'Net Cash Provided by (Used in) Investing Activities', depth: 1, order: 2, group: 'Cash Flow' },
            { label: 'Cash From Financing Activities', search: 'Net Cash Provided by (Used in) Financing Activities', depth: 1, order: 3, group: 'Cash Flow' },
            { label: 'Capital Expenditures', search: 'Payments to Acquire Property, Plant, and Equipment', depth: 1, order: 4, group: 'Cash Flow' },
            { label: 'Free Cash Flow', calc: 'fcf', depth: 1, order: 5, group: 'Cash Flow' },
            { label: 'Net Change in Cash', search: 'Cash, Cash Equivalents, Restricted Cash and Restricted Cash Equivalents, Period Increase (Decrease), Including Exchange Rate Effect', depth: 1, order: 6, group: 'Cash Flow' }
         ];

         // 2. Extract unique labels from data (IS, BS, CF)
         const uniqueLabels = new Map();
         fin_data.forEach(item => {
             if (!uniqueLabels.has(item.label)) {
                 let group = 'Others';
                 if(item.statement_type.includes('income_statement')) group = 'Income Statement';
                 else if(item.statement_type.includes('balance_sheet')) group = 'Balance Sheet';
                 else if(item.statement_type.includes('cash_flow')) group = 'Cash Flow';
                 
                 uniqueLabels.set(item.label, { 
                     label: item.label, 
                     depth: item.depth,
                     is_total: item.is_total,
                     order: item.order !== undefined ? item.order : 9999,
                     search: item.label,
                     group: group
                 });
             }
         });
         
         const rawDataRows = Array.from(uniqueLabels.values());
         
         return { summary: newDefaults, raw: rawDataRows };
    }

    function fin_processData() {
        const displayPeriods = fin_selectedPeriods;
        if(displayPeriods.length === 0) return { periods: [], rows: [] };

        const potential = fin_getAllPotentialRows();
        let rowsToRender = [];

        // If no config saved, use Default Summary
        if (!fin_rowConfig || fin_rowConfig.length === 0) {
            rowsToRender = potential.summary;
        } else {
            // Reconstruct rows based on saved config
            const configMap = new Map(fin_rowConfig.map(c => [c.id, c]));
            
            // Gather all available definitions
            const allDefs = [...potential.summary, ...potential.raw];
            
            // Filter unique by label to avoid duplicates in lookup
            const defMap = new Map();
            allDefs.forEach(d => defMap.set(d.label, d));
            
            rowsToRender = [];
            fin_rowConfig.forEach(conf => {
                if(conf.visible) {
                    const def = defMap.get(conf.id);
                    if(def) {
                        // Apply custom label if exists
                        const renderRow = { ...def };
                        if(conf.customLabel) renderRow.label = conf.customLabel; // Override for display
                        // Keep original search key
                        renderRow.search = def.search || def.label; 
                        rowsToRender.push(renderRow);
                    }
                }
            });
        }

        // Build Table Data Matrix
        const matrix = rowsToRender.map(row => {
            if(row.isHeader) return { ...row, isHeader: true };
            
            const rowValues = displayPeriods.map(p => {
                let val = null;
                
                if (row.calc === 'growth') {
                    val = fin_getGrowth(fin_data, p, row.target);
                } else if (row.calc === 'ratio') {
                    const n = findValue(fin_data, p, row.num);
                    const d = findValue(fin_data, p, row.den);
                    if(n !== null && d !== null && d !== 0) val = (n/d) * 100;
                } else if (row.calc === 'fcf') {
                    const ocf = findValue(fin_data, p, 'Net Cash Provided by (Used in) Operating Activities');
                    const capex = findValue(fin_data, p, 'Payments to Acquire Property, Plant, and Equipment');
                    if(ocf !== null && capex !== null) val = ocf + capex;
                } else if (row.calc === 'quick_ratio') {
                    // (Cash + Cash Equiv + Marketable Securities + AR) / Current Liabilities
                    const ca = findValue(fin_data, p, 'Assets, Current') || 0;
                    const cl = findValue(fin_data, p, 'Liabilities, Current');
                    if (cl) val = (ca / cl) * 100;
                } else if (row.calc === 'ar_days') {
                    // (AR / Revenue) * Days (90 or 365)
                    const ar = findValue(fin_data, p, 'Accounts Receivable, after Allowance for Credit Loss, Current');
                    const rev = findValue(fin_data, p, 'Total Revenue');
                    if (ar !== null && rev) {
                        const days = p.startsWith('Q') ? 90 : 365;
                        val = (ar / rev) * days;
                    }
                } else {
                    val = findValue(fin_data, p, row.search);
                }
                return val;
            });

            return { ...row, values: rowValues };
        });

        return { periods: displayPeriods, rows: matrix };
    }

    function findValue(data, period, label) {
        const item = data.find(d => d.period === period && d.label === label);
        return item ? item.value : null;
    }

    function fin_renderTable() {
        const result = fin_processData();
        const container = document.getElementById('fin-table-container');

        if(result.periods.length === 0) {
             container.innerHTML = '<div class="p-8 text-center text-gray-500">No periods selected.</div>';
             return;
        }

        const formatHeader = (p) => {
            const parts = p.split(' ');
            const yr = parts[1].slice(2);
            if(parts[0].startsWith('Q')) return `${parts[0].charAt(1)}Q${yr}`;
            if(parts[0] === 'FY') return `FY${yr}`;
            return p;
        };

        let html = `
            <table class="w-full text-sm border-collapse table-fixed" id="financials-data-table">
        <thead>
            <tr class="bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                <th class="p-2 border-b border-r text-left fin-label-col" style="width: 280px;">
                    Items
                    <div class="resizer" onmousedown="fin_initResize(event, this)"></div>
                </th>
                        ${result.periods.map(p => `
    <th class="p-2 border-b border-r text-right min-w-[100px] relative">
        ${formatHeader(p)}
        <div class="resizer" onmousedown="fin_initResize(event, this)"></div>
    </th>
`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        result.rows.forEach(row => {
            if (row.isHeader) {
                html += `
                    <tr class="bg-gray-200 font-bold text-gray-800">
                        <td class="p-2 border-b border-r" colspan="${result.periods.length + 1}">${row.label}</td>
                    </tr>
                `;
            } else {
                
                const dVal = parseInt(row.depth) || 1;
                let rowClass = 'hover:bg-blue-50 transition-colors group';
                
                // Indentation Calculation
                // Base padding left 8px
                // Depth 1 -> +12px
                // Depth 2 -> +24px
                const paddingLeft = 8 + ((dVal-1) * 16);
                
                let cellStyle = `padding-left: ${paddingLeft}px;`;
                let cellClass = 'py-2 pr-2 border-b border-r fin-label-col relative text-black';
                
                // Handle Empty Row Check
                const isAllNull = row.values.every(v => v === null);
                if (isAllNull) rowClass = 'bg-gray-50'; 

                if ((row.is_total && row.is_total !== 'False')) {
                    cellClass += ' font-bold'; 
                } 

                const cells = row.values.map(v => {
    if (v === null) return '<td class="p-2 border-b border-r text-right text-gray-300"></td>';
    
    let formatted = '';
    
    // Formatting Logic
    // EPS or Growth (non-ratio growth is rare, handled by isRatio generally)
    if (row.isRatio || row.label.includes('%')) {
        formatted = formatNumber(v, 1) + '%';
    } else if (row.isEPS || row.label.includes('Earnings Per Share') || row.label.includes('EPS')) {
        formatted = formatNumber(v, 2); // 2 decimals, raw value
    } else if (row.label.includes('Days')) {
        formatted = formatNumber(v, 0);
    } else {
        formatted = formatNumber(v / 1e6, 0);
    }
    const colorClass = v < 0 ? 'text-red-600' : 'text-gray-700';

    return `<td class="p-2 border-b border-r text-right ${colorClass}">${formatted}</td>`;
}).join('');

                html += `
                    <tr class="${rowClass}">
                        <td class="${cellClass}" style="${cellStyle}" title="${row.label}">
                            ${row.label}
                        </td>
                        ${cells}
                    </tr>
                `;
            }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // --- Resize Logic ---
    let startX, startWidth, resizableCol;

    function fin_initResize(e, resizer) {
        e.preventDefault(); 
        resizableCol = resizer.parentElement;
        startX = e.pageX;
        startWidth = resizableCol.offsetWidth;
        
        document.addEventListener('mousemove', fin_doResize);
        document.addEventListener('mouseup', fin_stopResize);
        document.body.style.cursor = 'col-resize';
    }

    function fin_doResize(e) {
        if(resizableCol) {
            const width = startWidth + (e.pageX - startX);
            if (width > 50) { 
                resizableCol.style.width = width + 'px';
                resizableCol.style.minWidth = width + 'px';
            }
        }
    }

    function fin_stopResize() {
        resizableCol = null;
        document.removeEventListener('mousemove', fin_doResize);
        document.removeEventListener('mouseup', fin_stopResize);
        document.body.style.cursor = '';
    }
    
    // --- Row Config Logic with Grouping & DnD ---
    let dragSrcEl = null;

    function fin_openRowConfig() {
        const potential = fin_getAllPotentialRows();
        const fullList = [...potential.summary, ...potential.raw];
        
        // De-duplicate
        const unique = [];
        const seen = new Set();
        fullList.forEach(r => {
             if(!seen.has(r.label)) {
                 unique.push(r);
                 seen.add(r.label);
             }
        });

        const listContainer = document.getElementById('fin-row-config-list');
        listContainer.innerHTML = '';
        
        // Populate config. Group by 'group'.
        // If config exists, respect it.
        
        let displayList = [];
        
        if (fin_rowConfig && fin_rowConfig.length > 0) {
             const configMap = new Map(fin_rowConfig.map(c => [c.id, c]));
             fin_rowConfig.forEach(conf => {
                  const def = unique.find(u => u.label === conf.id);
                  if(def) displayList.push({ ...def, visible: conf.visible, customLabel: conf.customLabel });
             });
             // Add remaining unchecked
             unique.forEach(u => {
                  if(!configMap.has(u.label)) displayList.push({ ...u, visible: false });
             });
        } else {
             // Default: Summary items (which are grouped by Metrics/Income/Balance/Cash) checked
             // Sort by Group Order: Income -> Balance -> Cash -> Others
             const groupOrder = { 'Income Statement': 1, 'Balance Sheet': 2, 'Cash Flow': 3, 'Metrics': 4, 'Others': 99 };
             
             // Check if it exists in Summary defaults
             const summarySet = new Set(potential.summary.map(s => s.label));
             
             displayList = unique.map(u => ({ ...u, visible: summarySet.has(u.label) }));
             displayList.sort((a,b) => (groupOrder[a.group]||99) - (groupOrder[b.group]||99));
        }
        
        // Render with Groups
        let currentGroup = '';
        displayList.forEach((row, idx) => {
             if(row.group !== currentGroup) {
                 currentGroup = row.group;
                 listContainer.innerHTML += `<div class="font-bold text-sm bg-gray-100 p-2 mt-2 rounded sticky top-0 z-10">${currentGroup}</div>`;
             }
             
             // Indentation for visualization in config
             const padLeft = (parseInt(row.depth||1) - 1) * 12;
             
             listContainer.innerHTML += `
                <div class="flex items-center gap-2 p-1 border-b bg-white draggable-item" draggable="true" data-id="${row.label}" style="padding-left:${padLeft+4}px">
                    <span class="material-icons text-gray-300 cursor-move text-sm">drag_indicator</span>
                    <input type="checkbox" class="fin-row-cb" ${row.visible ? 'checked' : ''}>
                    <div class="flex-1">
                        <input type="text" class="fin-row-rename border-none bg-transparent w-full text-sm focus:bg-blue-50 focus:outline-none" value="${row.customLabel || row.label}" placeholder="${row.label}">
                    </div>
                </div>
            `;
        });
        
        // Init DnD listeners
        const draggables = document.querySelectorAll('.draggable-item');
        draggables.forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOverList);
            item.addEventListener('drop', handleDropList);
            item.addEventListener('dragend', handleDragEnd);
        });
        
        document.getElementById('fin-row-config-modal').style.display = 'flex';
    }
    
    // DnD Handlers
    function handleDragStart(e) {
        this.classList.add('dragging');
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }
    
    function handleDragOverList(e) {
        if (e.preventDefault) e.preventDefault();
        return false;
    }

    function handleDropList(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
             // Simple swap logic or insert before
             // To support reordering within list
             const list = document.getElementById('fin-row-config-list');
             // Determine position
             const bounding = this.getBoundingClientRect();
             const offset = bounding.y + (bounding.height / 2);
             if (e.clientY - offset > 0) {
                 this.after(dragSrcEl);
             } else {
                 this.before(dragSrcEl);
             }
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
    }
    
    function fin_applyRowConfig() {
        const items = document.querySelectorAll('#fin-row-config-list .draggable-item');
        const newConfig = [];
        items.forEach((div, index) => {
            const id = div.dataset.id;
            const visible = div.querySelector('.fin-row-cb').checked;
            const customLabel = div.querySelector('.fin-row-rename').value;
            // Only save if visible or if we want to save order of unchecked too? 
            // Better to save full state to preserve order
            newConfig.push({ id: id, visible: visible, customLabel: customLabel === id ? null : customLabel, customOrder: index });
        });
        
        fin_rowConfig = newConfig;
        document.getElementById('fin-row-config-modal').style.display = 'none';
        fin_renderTable();
    }
    
    function fin_closeRowConfig(e) {
        if (!e || e.target.id === 'fin-row-config-modal' || e.target.closest('.btn-ghost')) {
            document.getElementById('fin-row-config-modal').style.display = 'none';
        }
    }
    
    function fin_saveConfig() {
        const req = requests.find(r => r.id === currentReqId);
        if(req) {
            req.finConfig = fin_rowConfig;
            req.finPeriods = fin_selectedPeriods;
            alert("Financial Layout Saved for this Request.");
        }
    }

</script>
</body>
</html>
